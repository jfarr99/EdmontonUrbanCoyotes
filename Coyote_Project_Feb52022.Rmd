---
title: "Coyote_Project_Feb52022"
author: "Jonathan Farr"
date: "2/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading in libraries
```{r, echo=FALSE}
library(ordinal) # ordinal regressions 
library(tidyverse) # data manipulation 
library(gridExtra) # multipanel plots
library(Hmisc) # correlation coefficients
library(lubridate) # dealing with dates
library(viridis)
library(corrplot) # for visualizing chi square residuals
library(chisq.posthoc.test) 
library(cowplot)
library(ggprism)
library(MuMIn) # model selection 

library(raster) # reading in raster files
library(sf) # for reading in shapefiles 

```





# Spatial Data

## Reading in Coyote Points
```{r}
# read in coyotes as sf object
Coyotes.sf= st_transform(st_as_sf(x = read.csv("UrbanCoyotes_March3_2022_Nad1983.csv"), 
                                  coords = c("Long", "Lat"),
                                  crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" ), # read in as WGS84
           crs="+proj=utm +zone=12 +datum=NAD83 +units=m +no_defs ") # transform to NAD83

```

## Reading in Spatial Data and adding to points
With each line of code we are: 
a) reading in a raster from a specific folder
b) dividing the values in that raster by the max # cells in a buffer zone to generate proportions
c) using the extract function to assign those raster values to points in Coyotes.sf
d) adding these points to the correct data frame as a new column 
```{r}
Coyotes = data.frame(x = c(1:9134))
                
# LAND COVER 100M BUFFER
Coyotes$Com100m = raster::extract(raster("Data/GIS_Layers/LandCover100m/Com100m.tif")/317, Coyotes.sf)
Coyotes$Res100m = raster::extract(raster("Data/GIS_Layers/LandCover100m/Res100m.tif")/317, Coyotes.sf)
Coyotes$Mod100m = raster::extract(raster("Data/GIS_Layers/LandCover100m/Mod100m.tif")/317, Coyotes.sf)
Coyotes$Mow100m = raster::extract(raster("Data/GIS_Layers/LandCover100m/Mow100m.tif")/317, Coyotes.sf)
Coyotes$Water100m = raster::extract(raster("Data/GIS_Layers/LandCover100m/Water100m.tif")/317, Coyotes.sf)
Coyotes$Nat100m = raster::extract(raster("Data/GIS_Layers/LandCover100m/Nat100m.tif")/317, Coyotes.sf)
Coyotes$Build100m = raster::extract(raster("Data/GIS_Layers/LandCover100m/Build100m.tif")/317, Coyotes.sf)
Coyotes$Roads100m = raster::extract(raster("Data/GIS_Layers/LandCover100m/Roads100m.tif")/317, Coyotes.sf)

# LAND COVER 200M BUFFER
Coyotes$Com200m = raster::extract(raster("Data/GIS_Layers/LandCover200m/Com200m.tif")/1257, Coyotes.sf)
Coyotes$Res200m = raster::extract(raster("Data/GIS_Layers/LandCover200m/Res200m.tif")/1257, Coyotes.sf)
Coyotes$Mod200m = raster::extract(raster("Data/GIS_Layers/LandCover200m/Mod200m.tif")/1257, Coyotes.sf)
Coyotes$Mow200m = raster::extract(raster("Data/GIS_Layers/LandCover200m/Mow200m.tif")/1257, Coyotes.sf)
Coyotes$Water200m = raster::extract(raster("Data/GIS_Layers/LandCover200m/Water200m.tif")/1257, Coyotes.sf)
Coyotes$Nat200m = raster::extract(raster("Data/GIS_Layers/LandCover200m/Nat200m.tif")/1257, Coyotes.sf)
Coyotes$Build200m = raster::extract(raster("Data/GIS_Layers/LandCover200m/Build200m.tif")/1257, Coyotes.sf)
Coyotes$Roads200m = raster::extract(raster("Data/GIS_Layers/LandCover200m/Roads200m.tif")/1257, Coyotes.sf)

# LAND COVER 400M BUFFER
Coyotes$Com400m = raster::extract(raster("Data/GIS_Layers/LandCover400m/Com400m.tif")/5025, Coyotes.sf)
Coyotes$Res400m = raster::extract(raster("Data/GIS_Layers/LandCover400m/Res400m.tif")/5025, Coyotes.sf)
Coyotes$Mod400m = raster::extract(raster("Data/GIS_Layers/LandCover400m/Mod400m.tif")/5025, Coyotes.sf)
Coyotes$Mow400m = raster::extract(raster("Data/GIS_Layers/LandCover400m/Mow400m.tif")/5025, Coyotes.sf)
Coyotes$Water400m = raster::extract(raster("Data/GIS_Layers/LandCover400m/Water400m.tif")/5025, Coyotes.sf)
Coyotes$Nat400m = raster::extract(raster("Data/GIS_Layers/LandCover400m/Nat400m.tif")/5025, Coyotes.sf)
Coyotes$Build400m = raster::extract(raster("Data/GIS_Layers/LandCover400m/Build400m.tif")/5025, Coyotes.sf)
Coyotes$Roads400m = raster::extract(raster("Data/GIS_Layers/LandCover400m/Roads400m.tif")/5025, Coyotes.sf)

# LAND COVER 800M BUFFER
Coyotes$Com800m = raster::extract(raster("Data/GIS_Layers/LandCover800m/Com800m.tif")/20081, Coyotes.sf)
Coyotes$Res800m = raster::extract(raster("Data/GIS_Layers/LandCover800m/Res800m.tif")/20081, Coyotes.sf)
Coyotes$Mod800m = raster::extract(raster("Data/GIS_Layers/LandCover800m/Mod800m.tif")/20081, Coyotes.sf)
Coyotes$Mow800m = raster::extract(raster("Data/GIS_Layers/LandCover800m/Mow800m.tif")/20081, Coyotes.sf)
Coyotes$Water800m = raster::extract(raster("Data/GIS_Layers/LandCover800m/Water800m.tif")/20081, Coyotes.sf)
Coyotes$Nat800m = raster::extract(raster("Data/GIS_Layers/LandCover800m/Nat800m.tif")/20081, Coyotes.sf)
Coyotes$Build800m = raster::extract(raster("Data/GIS_Layers/LandCover800m/Build800m.tif")/20081, Coyotes.sf)
Coyotes$Roads800m = raster::extract(raster("Data/GIS_Layers/LandCover800m/Roads800m.tif")/20081, Coyotes.sf)

# LAND COVER 1600M BUFFER
Coyotes$Com1600m = raster::extract(raster("Data/GIS_Layers/LandCover1600m/Com1600m.tif")/80425, Coyotes.sf)
Coyotes$Res1600m = raster::extract(raster("Data/GIS_Layers/LandCover1600m/Res1600m.tif")/80425, Coyotes.sf)
Coyotes$Mod1600m = raster::extract(raster("Data/GIS_Layers/LandCover1600m/Mod1600m.tif")/80425, Coyotes.sf)
Coyotes$Mow1600m = raster::extract(raster("Data/GIS_Layers/LandCover1600m/Mow1600m.tif")/80425, Coyotes.sf)
Coyotes$Water1600m = raster::extract(raster("Data/GIS_Layers/LandCover1600m/Water1600m.tif")/80425, Coyotes.sf)
Coyotes$Nat1600m = raster::extract(raster("Data/GIS_Layers/LandCover1600m/Nat1600m.tif")/80425, Coyotes.sf)
Coyotes$Build1600m = raster::extract(raster("Data/GIS_Layers/LandCover1600m/Build1600m.tif")/80425, Coyotes.sf)
Coyotes$Roads1600m = raster::extract(raster("Data/GIS_Layers/LandCover1600m/Roads1600m.tif")/80425, Coyotes.sf)


Coyotes[is.na(Coyotes)] = 0 # raplacing all NAs with 0 

# Cleaning up the environment
Coyote_Data = cbind(Coyotes, as.data.frame(Coyotes.sf))

rm(Coyotes, Coyotes.sf)
```

## Cleaning Coyote Data
We removed all reports prior to 2012, because of small sample sizes in 2010 (N=15) and 2011 (N = 112). We also binned the variable "CoyoteResponse" into 5 categories (instead of 10): Unknown (unk), Sightings (sight), Avoidance (avoid), Indifferent (indiff) and Aggressive (aggres) based on coyote boldness. 
```{r}

# cleaning all the data
Coyotes = Coyote_Data %>% 
  mutate(Date = as.Date(Date, format = "%m/%d/%Y")) %>% # formatting data properly
  filter(Date >= "2012-1-1") %>% # removing reports before Jan 1 2012
   mutate(Bold = fct_collapse(CoyoteResponse, Unknown = "Unknown", Sighting = "0", Avoidance = c("1", "2"), # binning boldness
                                     Indifferent = c("3", "4", "5"), Bold = c("6", "7"), Aggressive=c("8", "9")), 
         Bold= as.ordered(Bold), #making boldness an ordered factor
         Bold= fct_relevel(Bold, c("Unknown", "Sighting", "Avoidance", "Indifferent", "Bold", "Aggressive")), # boldness = increasing order
         CoyoteResponse = as.ordered(CoyoteResponse),
         Year_int = Year - 2011,
         Act = fct_relevel(HumanActivity, c("Unknown", "Walking", "Cycling", "Driving", "OutdoorAct", "HomeYard")), 
         Vul = fct_relevel(VulnerableIndividual, c("Unknown", "Child", "Dog", "Cat", "Multiple")), 
         Num = fct_relevel(CoyoteNumber, c("Unknown", "One", "Two", "Three", "More")), 
         Health = fct_relevel(Health, c("Unknown", "Unhealthy", "Healthy")), 
         RoadDistDecay = exp(-0.002*RoadDist), 
         Binary_conflict = fct_collapse(Bold, Unknown = "Unknown", Sighting = "Sighting", No_Conflict = c("Avoidance", "Indifferent"), Conflict = c("Bold", "Aggressive")))

# adding a variable with assigned habitat type, based on the habitat with the greaters % cover within 200m
Coyotes$Habitat  = as.factor(colnames(Coyotes[,c("Mod100m", "Res100m", "Mow100m", "Nat100m", "Com100m")])[apply(Coyotes[,c("Mod100m", "Res100m", "Mow100m", "Nat100m", "Com100m")],1,which.max)])


str(Coyotes)
rm(Coyote_Data)
```


# Question 1: How are coyote boldness or human perceptions affected by spatial (habitat, distance to roads, building density), temporal (season, time of day) and contextual factors (human activity type, presence or mention of vulnerable activity, number of coyotes, coyote health). 


## A) Coyote Boldness - Patterns 

First, making a data frame with appropriate reports - excluding all reports that are sightings
```{r}
bold.data = Coyotes %>%
  filter(Bold != "Unknown", Bold != "Sighting") %>%
  mutate(Year_int_scaled = scale(Year_int, scale = TRUE, center = TRUE))
# consider also removing reports of cat depredations and reports where reporters are driving
```

Second, transform our compositional land cover variables using a centered log-ratio transformation 
```{r}
bold.data.trans = bold.data

# for 100m buffer size
bold.data.trans[,c("Mod100m", "Mow100m", "Nat100m", "Water100m", "Com100m", "Res100m")] = compositions::clr(bold.data.trans[,c("Mod100m", "Mow100m", "Nat100m", "Water100m", "Com100m", "Res100m")]+1)

# for 200m buffer size 
bold.data.trans[,c("Mod200m", "Mow200m", "Nat200m", "Water200m", "Com200m", "Res200m")] = compositions::clr(bold.data.trans[,c("Mod200m", "Mow200m", "Nat200m", "Water200m", "Com200m", "Res200m")]+1)

# for 400m buffer size
bold.data.trans[,c("Mod400m", "Mow400m", "Nat400m", "Water400m", "Com400m", "Res400m")] = compositions::clr(bold.data.trans[,c("Mod400m", "Mow400m", "Nat400m", "Water400m", "Com400m", "Res400m")]+1)

# for 800m buffer size
bold.data.trans[,c("Mod800m", "Mow800m", "Nat800m", "Water800m", "Com800m", "Res800m")] = compositions::clr(bold.data.trans[,c("Mod800m", "Mow800m", "Nat800m", "Water800m", "Com800m", "Res800m")]+1)

# for 1600m buffer size
bold.data.trans[,c("Mod1600m", "Mow1600m", "Nat1600m", "Water1600m", "Com1600m", "Res1600m")] = compositions::clr(bold.data.trans[,c("Mod1600m", "Mow1600m", "Nat1600m", "Water1600m", "Com1600m", "Res1600m")]+1)

```

Third, we select the best-fit scale using univariate ordinal regressions. Based on the AIC values of univariate models, the best scales are Build200m, Res100m, Mod400m, Nat100m, Mow100m, Com200m
```{r}

bold.scale_models <- list()

for(i in c(1:5)){ # For each of your five scales (100, 200, 400, 800, 1600)
  # Define the variables you want to test.
  if(i==1){scales <- c("Mod100m", "Mow100m", "Nat100m", "Com100m", "Res100m", "Build100m")}
  if(i==2){scales <- c("Mod200m", "Mow200m", "Nat200m", "Com200m", "Res200m", "Build200m")}
  if(i==3){scales <- c("Mod400m", "Mow400m", "Nat400m", "Com400m", "Res400m", "Build400m")}
  if(i==4){scales <- c("Mod800m", "Mow800m", "Nat800m", "Com800m", "Res800m", "Build800m")}
  if(i==5){scales <- c("Mod1600m", "Mow1600m", "Nat1600m", "Com1600m", "Res1600m", "Build1600m")}
  
  
  # Create a data frame to store the results from all the models.
  bold.scale_models[[i]] <- data.frame()
  
  # For every variable you want to test:
  for(j in c(scales)){
    
    model <- clm(Bold ~ bold.data.trans[,j], # Create the predictive model
                  data=bold.data.trans)
    
    bold.scale_models[[i]][j,1] <- j # First column is the predictor
    bold.scale_models[[i]][j,2] <- AIC(model) # Second column is AIC
    bold.scale_models[[i]][j,3] <- coef(model)[4] # coefficient
    bold.scale_models[[i]][j,4] <- coef(summary(model))[4,4] # p value


  }
  
  colnames(bold.scale_models[[i]]) <- c("predictor", "AIC", "coef", "pval")
  rm(model, scales) # Keep workspace clean
}

bold.scale.model.outputs <- dplyr::bind_rows(bold.scale_models)

rm(bold.scale_models)

```

Fourth, we evaluate correlations between our variables using R-squared tests. Strong correlations between building density/road dist decay and Res100m. So, because res100m has the bigger (worst) AIC value, we remove it from analyses going forward.
```{r}
rcorr(as.matrix(bold.data.trans[,c("RoadDistDecay", "Mod400m", "Nat100m", "Mow100m", "Build200m", "Com200m", "Res100m")]), type = c("spearman"))
```


Finally, we construct full models and select the most parsimonious models using AIC 

New garbage messy mess
```{r}
# first, construct model without year 
bold.model.base = clm(Bold ~ scale(RoadDistDecay, scale= TRUE, center = TRUE) + 
                        scale(Mod400m, center = TRUE, scale = TRUE) + scale(Nat100m, center = TRUE, scale = TRUE)
                      + scale(Mow100m, center = TRUE, scale = TRUE) + scale(Build200m, center = TRUE, scale = TRUE)
                      + scale(Com200m, center = TRUE, scale = TRUE) +  Season + # additive effects
                            scale(Mod400m, center = TRUE, scale = TRUE)*Season +  scale(Nat100m, center = TRUE, scale = TRUE)*Season +
                        scale(Mow100m, center = TRUE, scale = TRUE)*Season + scale(RoadDistDecay, scale= TRUE, center = TRUE)*Season + 
                        scale(Build200m, center = TRUE, scale = TRUE)*Season, # biologically relevant interactions (see below)
                      data = bold.data.trans, na.action = "na.fail")
#bold.model.base.dredge = dredge(bold.model.base)
summary(bold.model.base)

# rationale for interaction terms: 
  # Mod400m*Season = test for changes in behaviour due to denning behaviour in more natural habitat 
  # Nat100m*Season = test for changes in behaviour due to denning behaviour in more natural habitat 
  # Mow100*Season = test for changes in behaviour due to denning behaviour in more natural habitat 
  # RoadDistDecay*Season = test to see if coyotes are behaving differently near roads in diff seasons
  # Build200m*Season = test if coyote behaviour in relation to development changes over season 

bold.model.base.dredge.variables <- model.avg(bold.model.base.dredge, subset=delta < 2) 
summary(bold.model.base.dredge.variables) # see which coefficients made it into the top mods


# variables for global model: Build200m, Mod400m, Mow100m, RoadDistDecay, Season, Com200m, Nat100m, 
# interactions for global: Mow100m*Season, Mod400m*Season, RoadDistDecay*Season
# include YEAR in the global mod for NOW 

# interactions only for variables with significant effects in base models 
bold.model.global = clm(Bold ~ scale(RoadDistDecay, scale= TRUE, center = TRUE) + 
                        scale(Nat100m, center = TRUE, scale = TRUE)
                      + scale(Com200m, center = TRUE, scale = TRUE) +
                        Year_int_scaled + 
                        scale(Mod400m, center = TRUE, scale = TRUE)*Season*Year_int_scaled + 
                        scale(Mow100m, center = TRUE, scale = TRUE)*Season*Year_int_scaled + 
                        scale(RoadDistDecay, scale= TRUE, center = TRUE)*Season + 
                        scale(RoadDistDecay, scale= TRUE, center = TRUE)*Year_int_scaled + 
                        scale(Build200m, scale= TRUE, center = TRUE)*Year_int_scaled, # interactions no year
                      data = bold.data.trans, na.action = "na.fail")
summary(bold.model.global)

bold.model.global.dredge = dredge(bold.model.global)

bold.models.list = get.models(bold.model.global.dredge, subset = delta < 2)

bold.models.output = data.frame()


scaledshit <- data.frame(
  conf_2.5 = confint(bold.models.list[["750"]], level=0.95)[,1],
  odds = coef(bold.models.list[["750"]])[-c(1:3)],
  conf_97.5 = confint(bold.models.list[["750"]], level=0.95)[,2],
  weight = 1, 
  Response = "Coyote Boldness",
  Model = "one")
scaledshit$Variable= rownames(scaledshit)


bold.results.mod1 <- data.frame(
  conf_2.5 = confint(bold.models.list[["494"]], level=0.95)[,1],
  odds = coef(bold.models.list[["494"]])[-c(1:3)],
  conf_97.5 = confint(bold.models.list[["494"]], level=0.95)[,2],
  weight = 1, 
  Response = "Coyote Boldness",
  Model = "one")
bold.results.mod1$Variable= rownames(bold.results.mod1)

bold.results.mod2 <- data.frame(
  conf_2.5 = confint(bold.models.list[["1006"]], level=0.95)[,1],
  odds = coef(bold.models.list[["1006"]])[-c(1:3)],
  conf_97.5 = confint(bold.models.list[["1006"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Coyote Boldness",
  Model = "two")
bold.results.mod2$Variable= rownames(bold.results.mod2)

bold.results.mod3 <- data.frame(
  conf_2.5 = confint(bold.models.list[["496"]], level=0.95)[,1],
  odds = coef(bold.models.list[["496"]])[-c(1:3)],
  conf_97.5 = confint(bold.models.list[["496"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Coyote Boldness", 
  Model = "three")
bold.results.mod3$Variable= rownames(bold.results.mod3)

bold.results = rbind(bold.results.mod1, bold.results.mod2, bold.results.mod3)

bold.results$Vars = factor(bold.results$Variable, 
                               levels = rev(c("Year_int_scaled", "SeasonPupRearing", "SeasonDispersal",
                                          "RoadDistDecay", "Build200m",  "Mod400m",
                                          "Mod400m:SeasonPupRearing", "Mod400m:SeasonDispersal", 
                                          "Mow100m", "Mow100m:SeasonPupRearing", "Mow100m:SeasonDispersal", "Com200m")),
                               labels = rev(c("Year", "Pup Rearing Season", "Dispersal Season", "Road Distance Decay",
                                          "Building Density",  "Modified Open", 
                                          "Modified Open : Pup Rearing Season", "Modified Open : Dispersal Season", 
                                          "Mowed",  "Mowed : Pup Rearing Season", "Mowed : Dispersal Season","Commercial")))


ggplot(scaledshit, aes(y=odds, x=Variable, color = Model, alpha = weight)) + 
  geom_point(position=position_dodge(0.4), size=3)+
  ylab("\nLog Odds of Change in Ordinal Scale (95% CI)") + xlab("\nSpatial Predictor") +
  geom_errorbar(position = position_dodge(0.4), aes(x=Variable, ymin=conf_2.5, ymax=conf_97.5), width = 0, size = 1) +
  scale_color_manual(values =c("black", "black", "black")) + 
  theme_bw()+
  geom_hline(yintercept = 0, linetype="dashed") +
  theme(legend.position = "none",
    axis.text=element_text(size=15),
    axis.title=element_text(size=18, face="bold")) + 
  coord_flip()

```


Old garbage messy mess
```{r}

# first, construct model without year 
bold.model.base = clm(Bold ~ RoadDistDecay + Mod400m + Nat100m + Mow100m + Build200m + Com200m +  Season + # additive effects
                             Mod400m*Season + Nat100m*Season + Mow100m*Season, # biologically relevant interactions (see below)
                      data = bold.data.trans, na.action = "na.fail")
#bold.model.base.dredge = dredge(bold.model.base)

# rationale for interaction terms: 
  # Mod400m*Season = test for changes in behaviour due to denning behaviour in more natural habitat 
  # Nat100m*Season = test for changes in behaviour due to denning behaviour in more natural habitat 
  # Mow100*Season = test for changes in behaviour due to denning behaviour in more natural habitat 

bold.model.base.dredge.variables <- model.avg(bold.model.base.dredge, subset=delta < 2) # get all models within AIC < 2

bold.model.base.dredge.variables$coefficients# gives our variables to be input into the next set of models 

summary(bold.model.base.dredge.variables)

# next, construct global model including year
bold.model.global = clm(Bold ~ RoadDistDecay + Mod400m + Mow100m + Build200m +  Season + Year_int_scaled + # additive effects 
                             Mod400m*Season # interactions no year
                             + RoadDistDecay*Year_int_scaled + Mow100m*Year_int_scaled+ Build200m*Year_int_scaled + Season*Year_int_scaled +  Mod400m*Season*Year_int_scaled, # 3 way interactions
                      data = bold.data.trans, na.action = "na.fail")
summary(bold.model.global)
# bold.model.global.dredge = dredge(bold.model.global)

bold.model.global.dredge.variables <- model.avg(bold.model.global.dredge, subset=delta < 2) # get all models within AIC < 2
summary(bold.model.global.dredge.variables)

bold.model.global.1 = clm(Bold ~ RoadDistDecay + Mod400m + Mow100m + Build200m +  Season + Year_int_scaled + # additive effects 
                             Mod400m*Season,
                      data = bold.data.trans, na.action = "na.fail")
summary(bold.model.global.1)
scale_test(bold.model.global.1) # testing proportional odds assumption 


summary(clm(Bold ~ RoadDistDecay+ Mod400m + Build200m +Year_int_scaled, scale = ~ Mow100m + Season+ Mod400m*Season,
                      data = bold.data.trans, na.action = "na.fail"))

scale_test(bold.model.global.1) # testing proportional odds assumption 

bold.model.global.scale = clm(Bold ~ RoadDistDecay +Mod400m + Build200m  + Year_int, 
                              scale = ~  Mow100m + Season + Mod400m*Season,
                      data = bold.data.trans, na.action = "na.fail")
summary(bold.model.global.scale)

##
bold.results <- data.frame(
  conf_2.5 = confint(bold.mod.dredge.results, level=0.95)[,1],
  odds = coef(bold.mod.dredge.results),
  conf_97.5 = confint(bold.mod.dredge.results, level=0.95)[,2]
)

bold.results$var = rownames(bold.results)
bold.results$resp = "Coyote Boldness"
bold.results = bold.results[-c(1,2),]
bold.results

rm(bold.mod.dredge, bold.mod.dredge.results, bold.mod.full)

```

Let's explore using binary logistic regression to model conflict - > SHELF THIS FOR NOW
```{r}
bold.scale_models <- list()

for(i in c(1:5)){ # For each of your five scales (100, 200, 400, 800, 1600)
  # Define the variables you want to test.
  if(i==1){scales <- c("Mod100m", "Mow100m", "Nat100m", "Com100m", "Res100m", "Build100m")}
  if(i==2){scales <- c("Mod200m", "Mow200m", "Nat200m", "Com200m", "Res200m", "Build200m")}
  if(i==3){scales <- c("Mod400m", "Mow400m", "Nat400m", "Com400m", "Res400m", "Build400m")}
  if(i==4){scales <- c("Mod800m", "Mow800m", "Nat800m", "Com800m", "Res800m", "Build800m")}
  if(i==5){scales <- c("Mod1600m", "Mow1600m", "Nat1600m", "Com1600m", "Res1600m", "Build1600m")}
  
  
  # Create a data frame to store the results from all the models.
  bold.scale_models[[i]] <- data.frame()
  
  # For every variable you want to test:
  for(j in c(scales)){
    
    model <- glm(Bold ~ bold.data.trans[,j], family = binomial,# Create the predictive model
                  data=bold.data.trans)
    
    bold.scale_models[[i]][j,1] <- j # First column is the predictor
    bold.scale_models[[i]][j,2] <- AIC(model) # Second column is AIC
    bold.scale_models[[i]][j,3] <- coef(model)[2] # coefficient
    bold.scale_models[[i]][j,4] <- coef(summary(model))[2,4] # p value


  }
  
  colnames(bold.scale_models[[i]]) <- c("predictor", "AIC", "coef", "pval")
  rm(model, scales) # Keep workspace clean
}

bold.scale.model.outputs <- dplyr::bind_rows(bold.scale_models)

rm(bold.scale_models)


# best scales = res100m, Build200m, Mow100m, Mod200m, nat800m, Com1600m
rcorr(as.matrix(bold.data.trans[,c("RoadDistDecay", "Mod200m", "Nat800m", "Mow100m", "Build200m", "Com1600m", "Res100m")]), type = c("spearman"))
# remove build200m

bold.model.base = glm(Bold ~ RoadDistDecay + Mod200m + Nat800m + Mow100m + Res100m + Com1600m +  Season + # additive effects
                             Mod200m*Season + Nat800m*Season + Mow100m*Season, # biologically relevant interactions (see below)
                     family = binomial, data = bold.data.trans, na.action = "na.fail")
summary(bold.model.base)

bold.model.base.dredge = dredge(bold.model.base)
bold.model.base.dredge.variables <- model.avg(bold.model.base.dredge, subset=delta < 2) 
summary(bold.model.base.dredge.variables)

bold.model.global = glm(Bold ~ RoadDistDecay + Mod200m + Mow100m + Res100m + Com1600m + Season +
                          Year_int_scaled + Nat800m + 
                            Mod200m*Season # interactions no year
                          + RoadDistDecay*Year_int_scaled + Mow100m*Year_int_scaled+
                          Nat800m*Year_int_scaled+ Com1600m*Year_int_scaled + 
                          Res100m*Year_int_scaled+ Season*Year_int_scaled + 
                          Mod200m*Season*Year_int_scaled, # 3 way interactions
                      family = binomial, data = bold.data.trans, na.action = "na.fail")
summary(bold.model.global)

bold.model.global.dredge = dredge(bold.model.global)
bold.model.global.dredge.variables <- model.avg(bold.model.global.dredge, subset=delta < 2) 
summary(bold.model.global.dredge.variables)

model.bold.list = get.models(bold.model.global.dredge, subset = delta <2)


model.bold.list[["215"]]$prior.weights




for(i in length(model.bold.list)){ # For each of your five scales (100, 200, 400, 800, 1600)

  # Create a data frame to store the results from all the models.
    model.bold.output <- data.frame()
    
    model.bold.output[[i]][j,1] <- rownames(data.frame(model.bold.list[[i]][["coefficients"]]))# predictor
    model.bold.output[[i]][j,2] <- AIC(model.bold.list[[i]]) # Second column is AIC
    model.bold.output[[i]][j,3] <- data.frame(model.bold.list[[i]][["coefficients"]])[,1] # coefficient
    model.bold.output[[i]][j,4] <- confint(model.bold.list[[i]])[,2]# upper95
    model.bold.output[[i]][j,5] <- confint(model.bold.list[[i]])[,1] # p value

  
  colnames(model.bold.output) <- c("predictor", "AIC", "coef", "upper_conf", "lower_conf")
}


bold.scale.model.outputs <- dplyr::bind_rows(bold.scale_models)

rm(bold.scale_models)

rownames(data.frame(model.bold.list[["215"]][["coefficients"]]))




confint(model.bold.list[["215"]], level = 0.95)

```





## B) Human Perceptions - Patterns 

First, making a data frame with appropriate reports - excluding all reports that have no human perceptions mentioned.
```{r}
perc.data = Coyotes %>%
  filter(HumanPerception != "Unknown", HumanPerception != "Concern")%>%
  mutate(HumanPerception = as.ordered(HumanPerception), 
         HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")), 
        Year_int_scaled = scale(Year_int, scale = TRUE, center = TRUE))
# consider also removing reports of cat depredations and reports where reporters are driving
summary(perc.data$HumanPerception)
```

Second, transform our compositional land cover variables using a centered log-ratio transformation 
```{r}
perc.data.trans = perc.data

# for 100m buffer size
perc.data.trans[,c("Mod100m", "Mow100m", "Nat100m", "Water100m", "Com100m", "Res100m")] = compositions::clr(perc.data.trans[,c("Mod100m", "Mow100m", "Nat100m", "Water100m", "Com100m", "Res100m")]+1)

# for 200m buffer size 
perc.data.trans[,c("Mod200m", "Mow200m", "Nat200m", "Water200m", "Com200m", "Res200m")] = compositions::clr(perc.data.trans[,c("Mod200m", "Mow200m", "Nat200m", "Water200m", "Com200m", "Res200m")]+1)

# for 400m buffer size
perc.data.trans[,c("Mod400m", "Mow400m", "Nat400m", "Water400m", "Com400m", "Res400m")] = compositions::clr(perc.data.trans[,c("Mod400m", "Mow400m", "Nat400m", "Water400m", "Com400m", "Res400m")]+1)

# for 800m buffer size
perc.data.trans[,c("Mod800m", "Mow800m", "Nat800m", "Water800m", "Com800m", "Res800m")] = compositions::clr(perc.data.trans[,c("Mod800m", "Mow800m", "Nat800m", "Water800m", "Com800m", "Res800m")]+1)

# for 1600m buffer size
perc.data.trans[,c("Mod1600m", "Mow1600m", "Nat1600m", "Water1600m", "Com1600m", "Res1600m")] = compositions::clr(perc.data.trans[,c("Mod1600m", "Mow1600m", "Nat1600m", "Water1600m", "Com1600m", "Res1600m")]+1)


```

Third, we select the best-fit scale using univariate ordinal regressions. Based on the AIC values of univariate models, the best scales are Res800m, Mod1600m, Build200m, Nat1600m, Com100m, Mow800m
```{r}

perc.scale.models <- list()

for(i in c(1:5)){ # For each of your five scales (100, 200, 400, 800, 1600)
  # Define the variables you want to test.
  if(i==1){scales <- c("Mod100m", "Mow100m", "Nat100m", "Com100m", "Res100m", "Build100m")}
  if(i==2){scales <- c("Mod200m", "Mow200m", "Nat200m", "Com200m", "Res200m", "Build200m")}
  if(i==3){scales <- c("Mod400m", "Mow400m", "Nat400m", "Com400m", "Res400m", "Build400m")}
  if(i==4){scales <- c("Mod800m", "Mow800m", "Nat800m", "Com800m", "Res800m", "Build800m")}
  if(i==5){scales <- c("Mod1600m", "Mow1600m", "Nat1600m", "Com1600m", "Res1600m", "Build1600m")}
  
  
  # Create a data frame to store the results from all the models.
  perc.scale.models[[i]] <- data.frame()
  
  # For every variable you want to test:
  for(j in c(scales)){
    
    model <- clm(HumanPerception ~ perc.data.trans[,j], # Create the predictive model
                  data=perc.data.trans)
    
    perc.scale.models[[i]][j,1] <- j # First column is the predictor
    perc.scale.models[[i]][j,2] <- AIC(model) # Second column is AIC
    perc.scale.models[[i]][j,3] <- coef(model)[3] # coefficient
    perc.scale.models[[i]][j,4] <- coef(summary(model))[3,4] # p value


  }
  
  colnames(perc.scale.models[[i]]) <- c("predictor", "AIC", "coef", "pval")
  rm(model, scales) # Keep workspace clean
}

perc.scale.models.outputs <- dplyr::bind_rows(perc.scale.models)

rm(perc.scale.models)

```


Fourth, we evaluate correlations between our variables using R-squared tests. No big corrs
```{r}
rcorr(as.matrix(perc.data.trans[,c("Mod1600m", "Mow800m", "Nat1600m", "Com100m", "Res800m", "Build200m", "RoadDistDecay")]), type = c("spearman"))
```

Fifth, we construct full models and select the most parsimonious models using AIC 
```{r}
# first, construct model without year 
perc.model.base = clm(HumanPerception ~ RoadDistDecay + Mod1600m + Nat1600m + Mow800m + Build200m + Com100m + 
                      Res800m + Season + RoadDistDecay*Season + Mod1600m*Season + Nat1600m*Season + Mow800m*Season +
                        Build200m*Season + Com100m*Season + Res800m*Season, 
                      data = perc.data.trans, na.action = "na.fail")
#perc.model.base.dredge = dredge(perc.model.base)

perc.model.base.dredge.variables <- model.avg(perc.model.base.dredge, subset=delta < 2) 
summary(perc.model.base.dredge.variables) # see which coefficients made it into the top mods
# no interaction terms!!


# variables for global model: Build200m, Mod1600m, Mow800m, RoadDistDecay, Season, Com100m, Nat1600m, Res800m
# include YEAR in the global mod
# interactions between year and spatial variables are IMPERATIVE

# interactions only if significant effects existed in base model
perc.model.global = clm(HumanPerception ~ scale(RoadDistDecay, center = TRUE, scale = TRUE) + 
                          scale(Mod1600m, center = TRUE, scale = TRUE) +
                          scale(Nat1600m, center = TRUE, scale = TRUE) + 
                        scale(Mow800m, center = TRUE, scale = TRUE)+
                        scale(Build200m, center = TRUE, scale = TRUE)+
                        scale(Com100m, center = TRUE, scale = TRUE)+
                        scale(Res800m, center = TRUE, scale = TRUE)+
                          Year_int_scaled + 
                          scale(RoadDistDecay, center = TRUE, scale = TRUE)*Year_int_scaled + 
                         scale(Res800m, center = TRUE, scale = TRUE)*Year_int_scaled
, # interactions no year
                      data = perc.data.trans, na.action = "na.fail")
summary(perc.model.global)

perc.model.global.dredge = dredge(perc.model.global)

perc.models.list = get.models(perc.model.global.dredge, subset = delta < 2) # 25 top models (sheesH)

perc.top.mod <- data.frame(
  conf_2.5 = confint(perc.models.list[["486"]], level=0.95)[,1],
  odds = coef(perc.models.list[["486"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["486"]], level=0.95)[,2],
  weight = 1, 
  Response = "Human Concern",
  Model = "one")
perc.top.mod$Variable= rownames(perc.top.mod)


ggplot(perc.top.mod, aes(y=odds, x=Variable, color = Model, alpha = weight)) + 
  geom_point(position=position_dodge(0.8), size=3)+
  ylab("\nLog Odds of Change in Human Response (95% CI)") + xlab("\nSpatial Predictor") +
  geom_errorbar(position = position_dodge(0.8), aes(x=Variable, ymin=conf_2.5, ymax=conf_97.5), width = 0, size = 1) +
  scale_color_manual(values =c("black", "black", "black", "black", "black", "black", "black", "black")) + 
  theme_bw()+
  geom_hline(yintercept = 0, linetype="dashed") +
  theme(legend.position = "none",
    axis.text=element_text(size=15),
    axis.title=element_text(size=18, face="bold")) + 
  coord_flip()

```

getting data (gross and long) 
```{r}
perc.results.mod1 <- data.frame(
  conf_2.5 = confint(perc.models.list[["486"]], level=0.95)[,1],
  odds = coef(perc.models.list[["486"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["486"]], level=0.95)[,2],
  weight = 1, 
  Response = "Human Perception",
  Model = "one")
perc.results.mod1$Variable= rownames(perc.results.mod1)

perc.results.mod2 <- data.frame(
  conf_2.5 = confint(perc.models.list[["485"]], level=0.95)[,1],
  odds = coef(perc.models.list[["485"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["485"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Human Perception",
  Model = "two")
perc.results.mod2$Variable= rownames(perc.results.mod2)

perc.results.mod3 <- data.frame(
  conf_2.5 = confint(perc.models.list[["502"]], level=0.95)[,1],
  odds = coef(perc.models.list[["502"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["502"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Human Perception",
  Model = "three")
perc.results.mod3$Variable= rownames(perc.results.mod3)

perc.results.mod4 <- data.frame(
  conf_2.5 = confint(perc.models.list[["494"]], level=0.95)[,1],
  odds = coef(perc.models.list[["494"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["494"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Human Perception",
  Model = "four")
perc.results.mod4$Variable= rownames(perc.results.mod4)

perc.results.mod5 <- data.frame(
  conf_2.5 = confint(perc.models.list[["421"]], level=0.95)[,1],
  odds = coef(perc.models.list[["421"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["421"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Human Perception",
  Model = "five")
perc.results.mod5$Variable= rownames(perc.results.mod5)

perc.results.mod6 <- data.frame(
  conf_2.5 = confint(perc.models.list[["501"]], level=0.95)[,1],
  odds = coef(perc.models.list[["501"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["501"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Human Perception",
  Model = "six")
perc.results.mod6$Variable= rownames(perc.results.mod6)

perc.results.mod7 <- data.frame(
  conf_2.5 = confint(perc.models.list[["358"]], level=0.95)[,1],
  odds = coef(perc.models.list[["358"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["358"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Human Perception",
  Model = "seven")
perc.results.mod7$Variable= rownames(perc.results.mod7)

perc.results.mod8 <- data.frame(
  conf_2.5 = confint(perc.models.list[["488"]], level=0.95)[,1],
  odds = coef(perc.models.list[["488"]])[-c(1:2)],
  conf_97.5 = confint(perc.models.list[["488"]], level=0.95)[,2],
  weight = 0.3, 
  Response = "Human Perception",
  Model = "eight")
perc.results.mod8$Variable= rownames(perc.results.mod8)

perc.results = rbind(perc.results.mod1, perc.results.mod2, perc.results.mod3, perc.results.mod4,
                     perc.results.mod5, perc.results.mod6, perc.results.mod7, perc.results.mod8)

perc.results$Vars = factor(perc.results$Variable, 
                          levels = c("Mow800m", "Com100m", "Nat1600m",  "Build200m",
                                     "RoadDistDecay", "SeasonPupRearing", "SeasonDispersal", "Res800m", "Mod1600m",
                                     "Year_int_scaled"), 
                          labels = c("Mowed", "Commercial", "Natural",
                                     "Building Density", "Road Distance Decay", "Pup Rearing Season",
                                     "Dispersal Season","Residential", "Modified Open", "Year"))


```


Now we'll make a plot with results from both variables in the output
```{r}
pattern.results = rbind(perc.results, bold.results)

pattern.results$Vars = factor(pattern.results$Vars, levels = rev(c("Year", "Modified Open", "Pup Rearing Season", "Dispersal Season", 
                                                               "Road Distance Decay", "Residential", "Building Density", "Mowed",
                                                               "Modified Open : Pup Rearing Season", "Modified Open : Dispersal Season",
                                                               "Commercial", "Natural",  "Mowed : Pup Rearing Season", 
                                                               "Mowed : Dispersal Season")))


ggplot(pattern.results, aes(y=odds, x=Vars, color = Model, alpha = weight)) + 
  geom_point(position=position_dodge(0.6), size=3)+
  ylab("\nLog Odds of Increase in Ordinal Scale (95% CI)") + xlab("Explanatory Variable\n") +
  geom_errorbar(position = position_dodge(0.6), aes(x=Vars, ymin=conf_2.5, ymax=conf_97.5), width = 0, size = 1) +
  scale_color_manual(values =c("black", "black", "black", "black", "black", "black", "black", "black")) + 
  theme_bw()+
  geom_hline(yintercept = 0, linetype="dashed") +
  theme(legend.position = "none",
    axis.text=element_text(size=15),
    axis.title=element_text(size=18, face="bold")) + 
  facet_wrap(~Response) + 
  theme(strip.text = element_text(size = 20, face = "bold"), 
        strip.background = element_rect(fill= "white")) +
  coord_flip()


```

### i) Spatial variables associated with boldness
The most important part here is picking appropriate spatial variables to input to the model. My options are: 

- Habitat as a categorical variable (modified open, mowed, natural, residential, commercial) --> problem = correlated with build and road density
- Habitat as continuous variables (representing % land cover within buffer sizes) --> problem = some correlations exist between residential area and build/road density
- Building density and road density (correlated)
- Distance decay to roads 
- Distance to city centre, and distance to river valley

#### Descriptive figures & summary information from spatial variables

Percentages: Coyote Boldness & Human Perceptions across habitat types (measured at 200m buffer) and seasons (ARCHIVED FIGURE)
```{r}
# habitat use by season
bold.hab = Coyotes %>%  filter(Bold!="unk", Bold!="sight") %>%
  group_by(Season, Habitat, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
        Bold = recode(Bold, avoid = "Avoidance", indiff = "Indifferent", bold = "Bold", aggress= "Aggressive"))
bold.hab$Season =fct_relevel(bold.hab$Season, c("Breeding", "PupRearing", "Dispersal"))


bold.perc = Coyotes %>%  filter(HumanPerception !="Concern", HumanPerception!="Unknown")%>%
  group_by(Season, Habitat, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")))
bold.perc$Season =fct_relevel(bold.perc$Season, c("Breeding", "PupRearing", "Dispersal"))

label.position.hab.perc = rep(99, times=45)
label.position.hab.bold = rep(99, times=60)

bold.hab.plot = 
  ggplot(bold.hab, aes(x = Season, y = perc,  fill=Bold))+
  geom_bar(position = "stack", stat = "identity") +                    
  facet_grid(.~Habitat)+
  theme_bw() + ylab("% classifiable reports")+ 
  scale_fill_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1) + scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=Season, y = label.position.hab.bold,  label=total), vjust=1, size = 6) + 
  theme(axis.title = element_text(size = 20),axis.text = element_text(size = 15),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(),
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right", 
        strip.text.x = element_text(size = 20)) + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))

perc.hab.plot = 
  ggplot(bold.perc, aes(x = Season, y = perc,  fill=HumanPerception))+
  geom_bar(position = "stack", stat = "identity") +                    
  facet_grid(.~Habitat)+
  theme_bw() + ylab("% classifiable reports")+ 
  scale_fill_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1) + scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=Season, y = label.position.hab.perc,  label=total), vjust=1, size = 6) + 
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 15, angle = 45, hjust = 1), 
        axis.text.y=element_text(size = 15),
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right", 
        strip.text.x = element_text(size = 20)) + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))

cowplot::plot_grid( bold.hab.plot, perc.hab.plot, ncol = 1, align = "v")

```

### ii) Temporal variables associated with boldness

### iii) Contextual variables associated with boldness
```{r}




```

# Question 2: Have coyote boldness or human perceptions changed over the past 10 years of report collection? 


First, we use some nice visualizations to see if coyote boldness and human perceptions have changed over the duration of report collection 
```{r}
# making a data frame with percentages per year for BOLDNESS 
bold.time = Coyotes %>%  filter(Bold != "Unknown", Bold!= "Sighting")%>%
  group_by(Year, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count))

# making a data frame with percentages of human perceptions per year
perc.time = Coyotes %>%  filter(HumanPerception != "Concern", HumanPerception!="Unknown") %>%
  group_by(Year,  HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) %>%
  mutate(HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")))

# boldness plot
bold.time.plot = 
  ggplot(bold.time, aes(x = Year, y = perc,  fill=Bold))+
  geom_col(color = "black")+
 # geom_bar(stat = "identity", position=position_dodge(), color = "black") +       
  theme_bw()+ 
  #geom_smooth(method = "lm", aes(group= Bold, color = Bold))+
  scale_fill_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1)+ 
  scale_color_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1)+ 
  ylab("Percentage of classifiable reports")+ 
  geom_text(aes(x=Year, y = rep(99, times = 40),  label=total), vjust=1, size = 6) + 
  scale_y_continuous(expand = c(0.01, 0.01)) + scale_x_continuous("Year", breaks = seq(2012, 2021, 1)) + 
  theme(axis.title = element_text(size = 20),axis.text = element_text(size = 16), 
        legend.title = element_text(size = 20), legend.text = element_text(size = 16), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
       legend.position = "top")+ 
    guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))

perc.time.plot = 
  ggplot(perc.time, aes(x = Year, y = perc, fill=HumanPerception))+
  geom_col(color = "black")+
  theme_bw() + 
 # geom_bar(stat = "identity", position=position_dodge(), color = "black") +       
  #geom_smooth(aes(color = HumanPerception), method = "lm")+
    scale_fill_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1)+ 
        scale_color_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1)+ 
        ylab("Percentage of classifiable reports")+ 
  geom_text(aes(x=Year, y = rep(99, times = 30),  label=total), vjust=1, size = 6, color ="black") + 
  scale_y_continuous(expand = c(0.01, 0.01)) + scale_x_continuous("Year", breaks = seq(2012, 2021, 1)) + 
  theme(axis.title.x = element_text(size = 20), axis.text.x = element_text(size = 16), 
        axis.text.y = element_blank(), axis.title.y = element_blank(),
        legend.title = element_text(size = 20), legend.text = element_text(size = 16), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "top") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))

grid.arrange(bold.time.plot, perc.time.plot, nrow = 1)

```

## A) Coyote Boldness from 2012 - 2020
```{r}
# now, add in the variables that were significant before, each with an interaction with Year_int
bold.time.mod =  clm(Bold ~ RoadDistDecay + Mod400m + SchoolDistDecay + Mow100m + Build200m+ Season + 
                      RoadDistDecay*Season + Mod400m*Season + Mow100m*Season + Build200m*Season +
                       SchoolDistDecay*Season + Year_int, # interaction terms with year
                     data = bold.data.trans, na.action = "na.fail")
summary(bold.time.mod)

# dredge full model for model selection
bold.time.mod.dredge = MuMIn::dredge(bold.time.mod, rank ="AIC")

bold.time.mod.dredge.results <- MuMIn::model.avg(bold.time.mod.dredge, subset=delta < 2)

bold.time.results <- data.frame(
  conf_2.5 = confint(bold.time.mod.dredge.results, level=0.95)[,1],
  odds = coef(bold.time.mod.dredge.results),
  conf_97.5 = confint(bold.time.mod.dredge.results, level=0.95)[,2]
)

bold.time.results

bold.time.results$resp = "Coyote Boldness"
bold.time.results = bold.time.results[-c(1,2),]
bold.time.results$var = rownames(bold.time.results)

bold.time.results
```

## B) Human Perceptions from 2012 - 2020
```{r}

# now, add in the variables that were significant before, each with an interaction with Year_int
perc.time.mod =  clm(HumanPerception ~ Com1600m + Mod1600m + Nat1600m + Mow800m +Res800m + Season + Year_int,
                     data = perc.data.trans, na.action = "na.fail")
summary(perc.time.mod)

# dredge full model for model selection
perc.time.mod.dredge = MuMIn::dredge(perc.time.mod, rank ="AIC")

perc.time.mod.dredge.results <- MuMIn::model.avg(perc.time.mod.dredge, subset=delta < 2)

perc.time.results <- data.frame(
  conf_2.5 = confint(perc.time.mod.dredge.results, level=0.95)[,1],
  odds = coef(perc.time.mod.dredge.results),
  conf_97.5 = confint(perc.time.mod.dredge.results, level=0.95)[,2]
)

perc.time.results

perc.time.results$resp = "Human Perception"
perc.time.results = perc.time.results[-c(1,2),]
perc.time.results$var = rownames(perc.time.results)

perc.time.results
```

Now let's graph these two things together 
```{r}
time.results = rbind(perc.time.results, bold.time.results)
time.results

ggplot(time.results, aes(y=var, x=odds)) + 
  xlab("\nLog Odds of Change in Ordinal Scale (95% CI)") + ylab("\nSpatial Predictor") +
  labs(color = "Response Variable")+
  scale_color_manual(values = c("firebrick", "orange"))+
  theme_classic()+
  theme(
    axis.text=element_text(size=15, family="Times"),
    axis.title=element_text(size=18, face="bold", family="Times"))+
  geom_vline(xintercept=0, linetype=2)+
  geom_errorbar(aes(y=var, xmin=conf_2.5, xmax=conf_97.5), width=0, size=1, position=position_dodge(0.3)) + 
  facet_wrap(resp~.)+
  theme(panel.spacing.x=unit(0, "lines"),
        strip.text=element_text(size=20, face="bold", family="Times"),
        strip.placement = "outside", 
        panel.border = element_rect(fill=NA, color="black")) 
```


Regression analysis based on % data
```{r}
# Using regression analysis to look for differences over time 

# first, we find the appropriate distribution for our data 
gamlss::fitDist(count, data=subset(bold.time, Bold == "aggres"), type="counts", try.gamlss=TRUE) # best family = PIG (poisson inverse gaussian)
gamlss::histDist(subset(bold.time, Bold=="aggres")$count, "PIG", density=T) # visualizing fit

bold.time.aggres = subset(bold.time, Bold=="aggres") # subsetting data to only aggressive reports

# Fitting a full model (all variables of interest) to data 
bold.time.mod = gamlss::gamlss(count ~  total + Year_int + Season + Year_int*Season,
                  family = "PIG", data = bold.time.aggres)
#  model selection to identify the top model(s) using AICc (corrected for small sample sizes)
bold.time.mod.dredge = MuMIn::dredge(bold.time.mod, rank ="AICc")

# top model = no interaction term
MuMIn::get.models(bold.time.mod.dredge, subset = delta < 2)
summary(gamlss::gamlss(count ~  total + Year_int + Season,
                  family = "PIG", data = bold.time.aggres))

rm(bold.time, bold.time.aggres, bold.time.plot, bold.time.mod, bold.time.mod.dredge)

```

## B) Human Perceptions from 2012 - 2020

Regression analysis based on % data
```{r}
# Using regression analysis to look for differences over time 

# first, we find the appropriate distribution for our data 
gamlss::fitDist(count, data=subset(perc.time, HumanPerception == "Negative"), type="counts", try.gamlss=TRUE) # best family = 
gamlss::histDist(subset(perc.time, HumanPerception == "Negative")$count, "DPO", density=T) # BEST FIT FOR DATA

perc.time.neg = subset(perc.time, HumanPerception == "Negative")

# second, we fit the model to the data
perc.time.mod = gamlss::gamlss(count ~  total + Year_int + Season + Year_int*Season,
                  family = "DPO", data = perc.time.neg)
summary(perc.time.mod)
# third, we do model selection
perc.time.mod.dredge = MuMIn::dredge(perc.time.mod, rank = "AICc")

# top model = no interaction term
MuMIn::get.models(perc.time.mod.dredge, subset = delta < 2)

perc.time.mod.avg <- MuMIn::model.avg(perc.time.mod.dredge, subset=delta < 2)


summary(perc.time.mod.avg)

rm(perc.time, perc.time.neg, perc.time.plot, perc.time.mod, perc.time.mod.dredge, perc.time.mod.avg)

```

# Question 3: Which spatial, temporal and contextual variables were associated with any long-term changes in apparent conflict? 

Boldness by land cover by year --> somewhat informative
```{r}
# habitat use by season
bold.hab.year = Coyotes %>%  filter(Bold != "unk", Bold!= "sight") %>%
  group_by(Year, Habitat, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) 

bold.hab.year.labs = rep(99, times=175)

bold.hab.year.plot = 
  ggplot(bold.hab.year, aes(x = Year, y = perc,  fill=Bold))+
   geom_bar(position = "stack", stat = "identity") + # could also do as points, tbd                       
      facet_grid(Habitat~.)+
  theme_bw() + 
    scale_fill_viridis("Boldness", discrete=TRUE, option = "inferno", direction = -1)+ 
        ylab("Percentage of classifible annual reports") + 
      geom_text(aes(x=Year, y = bold.hab.year.labs,  label=total), vjust=1, size = 5) 

bold.hab.year.plot

```

Perception by land cover by year --> not really informative
```{r}
perc.time.hab = Coyotes %>%  filter(HumanPerception != "Concern", HumanPerception!="Unknown") %>%
  group_by(Year, Habitat, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) # column with total # reports 

perc.time.hab$HumanPerception = fct_relevel(perc.time.hab$HumanPerception, c( "Positive", "Neutral", "Negative"))

# plotting changes in the % of all 5 boldness categories over time  
  ggplot(perc.time.hab, aes(x = Year, y = perc, fill=HumanPerception))+
  geom_bar(position = "stack", stat = "identity") + # could also do as points, tbd                       
  facet_grid(Habitat~.) + 
  theme_bw()+ 
  scale_fill_viridis("Percep", discrete=TRUE, option = "inferno", direction = -1)+       
    geom_text(aes(x=Year, y = rep(99, times=114),  label=total), vjust=1, size = 6) +
    ylab("Percentage of annual reports")

  
```

Let's look for interactions between space & time
```{r}
# now, add in the variables that were significant before, each with an interaction with Year_int
bold.time.mod.int =  clm(Bold ~ Season + RoadDistDecay + Mod400m*Season + Mow100m*Season + Build200m + Year_int + 
                           Year_int*RoadDistDecay + Year_int*Mod400m*Season + Year_int*Mow100m*Season + Build200m*Year_int, # interaction terms with year
                     data = bold.data.trans, na.action = "na.fail")
summary(bold.time.mod.int)

# dredge full model for model selection
bold.time.mod.int.dredge = MuMIn::dredge(bold.time.mod.int, rank ="AIC")

bold.time.mod.int.dredge.results <- MuMIn::model.avg(bold.time.mod.int.dredge, subset=delta < 2)

bold.time.mod.int.results <- data.frame(
  conf_2.5 = confint(bold.time.mod.int.dredge.results, level=0.95)[,1],
  odds = coef(bold.time.mod.int.dredge.results),
  conf_97.5 = confint(bold.time.mod.int.dredge.results, level=0.95)[,2]
)

bold.time.mod.int.results

bold.time.mod.int.results$resp = "Coyote Boldness"
bold.time.mod.int.results = bold.time.mod.int.results[-c(1,2),]
bold.time.mod.int.results$var = rownames(bold.time.mod.int.results)

bold.time.mod.int.results


ggplot(bold.time.mod.int.results, aes(y=var, x=odds)) + 
  xlab("\nLog Odds of Change in Ordinal Scale (95% CI)") + ylab("\nSpatial Predictor") +
  labs(color = "Response Variable")+
  scale_color_manual(values = c("firebrick", "orange"))+
  theme_classic()+
  theme(
    axis.text=element_text(size=15, family="Times"),
    axis.title=element_text(size=18, face="bold", family="Times"))+
  geom_vline(xintercept=0, linetype=2)+
  geom_errorbar(aes(y=var, xmin=conf_2.5, xmax=conf_97.5), width=0, size=1, position=position_dodge(0.3)) 
```

# Supplementary Information 

## Patterns in Coyote Reporting across covariates

### Spatial Patterns in Coyote Reports 
```{r}
# reports across habitat types
hab.observed = Coyotes %>%
  group_by(Habitat) %>%
  summarise(count=n()) %>%
  mutate(var = "Observed", 
         perc = count)

# empty data frame for adding expected avlues
hab.expected = Coyotes %>% group_by(Habitat) %>%
  summarise(count=n()) %>%
  mutate(perc = "none", var = "Expected")

      # calculating expected percentages of reports, based on the area of that habitat type divided by the total area of the         study area (minus water, which we are not considering in this analysis)
      hab.expected$perc = ifelse(hab.expected$Habitat =="Com100m", 146.7/556*9134, hab.expected$perc) 
      hab.expected$perc = ifelse(hab.expected$Habitat =="Mod100m", 83.8/556*9134, hab.expected$perc) 
      hab.expected$perc = ifelse(hab.expected$Habitat =="Mow100m", 43.6/556*9134, hab.expected$perc ) 
      hab.expected$perc = ifelse(hab.expected$Habitat =="Nat100m", 44.9/556*9134, hab.expected$perc ) 
      hab.expected$perc = ifelse(hab.expected$Habitat =="Res100m", 236.5/556*9134, hab.expected$perc ) 

# Joining together the two data frames
hab.totals = rbind(hab.observed, hab.expected) %>%
  mutate(var = fct_relevel(var, c("Observed", "Expected")), 
         perc = as.numeric(perc), 
         Habitat = recode(Habitat, Com100m ="Commercial", Mod100m = "Modified Open", Mow100m = "Mowed", Nat100m = "Natural",
                          Res100m = "Residential"))

hab.totals$Habitat = fct_relevel(hab.totals$Habitat, c("Natural", "Modified Open", "Mowed", "Residential", "Commercial"))

table.hab = matrix(c(1016, 614, 111, 997, 5456,
                     2419, 1377, 716, 738, 3885), ncol = 2)
colnames(table.hab) =c( "observed", "expected")
rownames(table.hab) = c( "com", "mod", "mow", "nat", "res")

chisq.posthoc.test(table.hab, method = "bonferroni")


rm(hab.observed, hab.expected) #keep the environment clean 

# plotting 
hab.plot = 
  ggplot(hab.totals, aes(x=var, y= perc, fill = Habitat)) + 
  geom_col(color="black") + 
  theme_bw()+
  scale_fill_manual("Land Cover", values = c("chartreuse3", "cyan4", "skyblue2", "darkorchid3", "navy")) +
  ylab("Number of reports")+ 
  scale_y_continuous(expand = c(0.01, 0.01), guide = guide_prism_minor(), breaks = seq(0,9150, 1500)) +
  theme(axis.text.x = element_text(size = 15), 
        axis.text.y=element_text(size = 15), axis.title.x = element_blank(),
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y= element_text(size = 20),
        legend.position = "none") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0))

hab.plot

save_plot("Figures/Habitat.reporting.patterns.jpeg", hab.plot, base_width = 3.2, base_height= 8)

```

### Temporal Patterns in Coyote Reports

Reports over years
```{r}
reporting.years = Coyotes %>%
  group_by(Time = floor_date(Date, "4 months"), Season) %>%
  summarise(count = n())

reporting.years$Season = fct_relevel(reporting.years$Season, c("Breeding", "PupRearing", "Dispersal"))
reporting.years$Season = recode(reporting.years$Season, PupRearing = "Pup Rearing")

reporting.years.plot = 
  ggplot(reporting.years, aes(x=Time, y= count, fill=Season)) + 
  geom_bar(position="dodge", stat="identity", color="black") + 
  theme_bw()+
  ylab("Number of reports")+ xlab("Year")+
  scale_fill_viridis(discrete = TRUE) +
  scale_y_continuous(expand = c(0.01,0.01), guide = guide_prism_minor()) +   scale_x_date(date_labels = "%Y", breaks="1 year", expand = c(0.01,0.01)) +
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15), 
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(0.5, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.position = "top") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))

reporting.years.plot
```

Reports over months
```{r}
reporting.months = Coyotes %>%
  group_by(Month, Season) %>%
  summarise(count = n()) %>%
  mutate(Month = as.factor(Month)) %>%
  mutate(Month = recode(Month, '1'="Jan", '2'="Feb", '3'="Mar", '4'="Apr", '5'="May", '6'="Jun", '7'="Jul", '8'="Aug", '9'="Sep", '10'="Oct", '11'="Nov", '12'="Dec"))

reporting.months$Season = fct_relevel(reporting.months$Season, c("Breeding", "PupRearing", "Dispersal"))
reporting.months$Season = recode(reporting.months$Season, PupRearing = "Pup Rearing")


reporting.month.plot = 
  ggplot(reporting.months, aes(x=Month, y= count/sum(count)*100, fill=Season)) + 
  geom_bar(position="dodge", stat="identity", color="black") + 
  theme_bw()+
  ylab("Percentage of Reports") + geom_vline(xintercept= c(4.5,8.5), linetype = 2)+
  geom_text(label = "Breeding", x=2.5, y = 17.2, size = 6, color="grey30")+
  geom_text(label = "Pup Rearing", x=6.55, y = 17.2, size = 6, color="grey30")+
  geom_text(label = "Dispersal", x=10.5, y = 17.2, size = 6, color="grey30")+
  scale_fill_viridis(discrete = TRUE) +
  scale_y_continuous(expand = c(0.01, 0.01), lim = c(0,18,5), guide = guide_prism_minor()) +  
  theme(axis.title = element_text(size = 20), axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none")

reporting.month.plot
```

Reports diurnally
```{r}
reporting.diurnal = Coyotes %>%
  group_by(NightDay) %>%
  summarise(count = n()) %>%
  mutate(var = "Time of Day")

reporting.diurnal.plot = 
  ggplot(reporting.diurnal, aes(x=NightDay, y = count, fill=NightDay)) + 
  geom_col( color="black") + 
  theme_bw()+
  ylab("Number of reports")+ xlab("Time of Day") + 
  scale_fill_viridis(discrete = TRUE, direction = -1, option="cividis") +
  scale_y_continuous(expand = c(0.01, 0.01), guide = guide_prism_minor()) +  
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        legend.position = "none") 

reporting.diurnal.plot
```

###Contextual Patterns in Coyote Reporting - CHANGE TO TABLES
Human Activity
```{r}
# HUMAN ACTIVITY
act.reports = Coyotes %>%
  group_by(HumanActivity) %>%
  summarise(count=n()) %>%
  mutate(var = "Human Activity", 
         perc = count/sum(count)*100, 
         HumanActivity = as.ordered(HumanActivity)) %>%
  mutate(HumanActivity = fct_relevel(HumanActivity, c("Cycling", "OutdoorAct","Walking", "Driving", "HomeYard", "Unknown")))

reporting.act.plot = 
  ggplot(act.reports, aes(x=HumanActivity, y = count, fill=HumanActivity)) + 
  geom_bar(stat= "identity", position="dodge", color="black") + 
  theme_bw()+
  ylab("Number of reports")+ xlab("Human Activity")+
  scale_fill_brewer(palette="YlOrRd") +
  scale_y_continuous(expand = c(0.01, 0.01)) +  
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15),axis.title.y= element_blank(),
        axis.text.x =element_text(size = 15, angle= 45, hjust=1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 

reporting.act.plot
```

Vulnerable Individuals
```{r}
# VULNERABLE INDIVIDUALS
vul.reports = Coyotes %>%
  group_by(VulnerableIndividual) %>%
  summarise(count=n()) %>%
  mutate(var = "Vulnerable Individual", 
         perc = count/sum(count)*100, 
         VulnerableIndividual = as.ordered(VulnerableIndividual)) %>%
  mutate(VulnerableIndividual = fct_relevel(VulnerableIndividual, 
                                            c("Multiple", "Cat","Dog", "Child", "Unknown")))

reporting.vul.plot = 
  ggplot(vul.reports, aes(x=VulnerableIndividual, y = count, fill=VulnerableIndividual)) + 
  geom_bar(stat= "identity", position="dodge", color="black") + 
  theme_bw()+
  ylab("Number of reports")+ xlab("Vulnerable Individual")+
  scale_fill_brewer(palette="YlOrRd") +
  scale_y_continuous(expand = c(0.01, 0.01)) +  
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15),axis.title.y= element_blank(),
        axis.text.x =element_text(size = 15, angle= 45, hjust=1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 

reporting.vul.plot

```

Number of Coyotes
```{r}
num.reports = Coyotes %>%
  group_by(CoyoteNumber) %>%
  summarise(count=n()) %>%
  mutate(var = "Number of Coyotes", 
         perc = count/sum(count)*100, 
         CoyoteNumber = as.ordered(CoyoteNumber)) %>%
  mutate(CoyoteNumber = fct_relevel(CoyoteNumber, 
                                            c("One", "Two","Three", "More", "Unknown")))

num.reports.plot = 
  ggplot(num.reports, aes(x=CoyoteNumber, y = count, fill=CoyoteNumber)) + 
  geom_bar(stat= "identity", position="dodge", color="black") + 
  theme_bw()+
  ylab("Number of reports")+ xlab("Number of Coyotes")+
  scale_fill_brewer(palette="YlOrRd") +
  scale_y_continuous(expand = c(0.01, 0.01)) +  
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15),axis.title.y= element_blank(),
        axis.text.x =element_text(size = 15, angle= 45, hjust=1),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 

num.reports.plot
```

Coyote Health
```{r}
health.reports = Coyotes %>%
  group_by(Health) %>%
  summarise(count=n()) %>%
  mutate(var = "Coyote Health", 
         perc = count/sum(count)*100, 
         Health = as.ordered(Health)) %>%
  mutate(Health = fct_relevel(Health, c("Healthy", "Unhealthy","Unknown")))

health.reports.plot = 
  ggplot(health.reports, aes(x=Health, y = count, fill=Health)) + 
  geom_bar(stat= "identity", position="dodge", color="black") + 
  theme_bw()+
  ylab("Number of reports")+ xlab("Coyote Health")+
  scale_fill_brewer(palette="YlOrRd") +
  scale_y_continuous(expand = c(0.01, 0.01)) +  
  theme(axis.title = element_text(size = 20), axis.text = element_text(size = 15),
        axis.text.x =element_text(size = 15, angle= 45, hjust=1), axis.title.y= element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 

health.reports.plot


```

### NOW let's be a beast and plot everything together... hehe
```{r}
reporting.patterns = 
  ggdraw()+
  draw_plot(reporting.diurnal.plot, x= .7, y = 0, width =.3, height =0.9) + draw_plot_label(label = "C.", x=0.68, y=0.95, size = 30)+
  draw_plot(reporting.years.plot, x= 0.03, y = 0.5, width =.65, height =.5) + draw_plot_label(label = "A.", x=-0, y=0.95, size = 30)+
  draw_plot(reporting.month.plot, x= 0.03, y = 0, width =.65, height =.5) + draw_plot_label(label = "B.", x=0, y=0.55, size = 30)
#draw_plot(reporting.act.plot, x= 0, y = 0, width =.25, height =.33) + 
 # draw_plot(reporting.vul.plot, x= 0.25, y = 0, width =.25, height =.33) + 
#  draw_plot(num.reports.plot, x= 0.5, y = 0, width =.25, height =.33) + 
#  draw_plot(health.reports.plot, x= 0.75, y = 0, width =.25, height =.33) 

save_plot("Figures/Temporal.reporting.patterns.jpeg", reporting.patterns, base_width = 12, base_height= 8)
```

## Patterns in Coyote Boldness and Human Perceptions Across Covariates

### Spatial Patterns in Boldness & Perceptions

Boldness & Human Perceptions across habitat types
```{r}
# boldness across habitat types
bold.hab = Coyotes %>%  filter(Bold!="unk", Bold!="sight") %>%
  group_by(Habitat, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         Bold = recode(Bold, avoid = "Avoidance", indiff = "Indifferent", bold= "Bold", aggress = "Aggressive"),
         Habitat = recode(Habitat, Com100m ="Commercial", Mod100m = "Modified Open", Mow100m = "Mowed", Nat100m = "Natural",
                          Res100m = "Residential"))

# perceptions across habitat types
perc.hab = Coyotes %>%  filter(HumanPerception !="Concern", HumanPerception!="Unknown")%>%
  group_by(Habitat, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")),
         Habitat = recode(Habitat,  Com100m ="Commercial", Mod100m = "Modified Open", Mow100m = "Mowed", Nat100m = "Natural",
                          Res100m = "Residential"))

label.position.hab.perc = rep(99, times=15)
label.position.hab.bold = rep(99, times=20)

bold.hab.plot = 
  ggplot(bold.hab, aes(x = Habitat, y = perc,  fill=Bold))+
  geom_bar(position = "stack", stat = "identity") +                    
  theme_bw() + ylab("Percentage of Classifiable Reports")+ 
  scale_fill_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1) + scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=Habitat, y = label.position.hab.bold,  label=total), vjust=1, size = 6) + 
  theme(axis.title = element_text(size = 17),axis.text = element_text(size = 15),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(),
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))

perc.hab.plot = 
  ggplot(perc.hab, aes(x = Habitat, y = perc,  fill=HumanPerception))+
  geom_bar(position = "stack", stat = "identity") +                    
  theme_bw() + ylab("Percentage of Classifiable Reports")+ 
  scale_fill_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1) + scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=Habitat, y = label.position.hab.perc,  label=total), vjust=1, size = 6) + 
  theme(axis.title = element_text(size = 17), axis.text.x = element_text(size = 15, angle = 45, hjust = 1), 
        axis.text.y=element_text(size = 15),
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.ticks = element_blank(),
        legend.position = "right") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))
 
 ggdraw()+
  draw_plot(bold.hab.plot, x= 0, y = 0.58, width =0.965, height =.42)+ 
  draw_plot(perc.hab.plot, x= 0, y = 0, width =1, height =.58)
   
   

rm(perc.hab.plot, bold.hab.plot, bold.hab, perc.hab,label.position.hab.perc, label.position.hab.bold )
```

### Temporal Patterns in Boldness & Human perceptions

Over years, see above

Over months & coyote seasons
```{r}
# making a data frame with percentages per month for BOLDNESS 
bold.months = Coyotes %>%  filter(Bold!="unk", Bold!="sight")%>%
  group_by(Month, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         Bold = recode(Bold, avoid = "Avoidance", indiff = "Indifferent", bold= "Bold", aggress = "Aggressive"),
         Var = "Coyote Boldness", 
         Month = as.factor(Month))

# making a data frame with percentages of human perceptions per month
perc.months = Coyotes %>% filter(HumanPerception !="Concern", HumanPerception!="Unknown")%>%
  group_by(Month, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) %>%
  mutate(HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")), 
         Var = "Human Perception", 
         Month = as.factor(Month)) %>%
  mutate(Month = recode(Month, '1'="Jan", '2'="Feb", '3'="Mar", '4'="Apr", '5'="May", '6'="Jun", '7'="Jul", '8'="Aug", '9'="Sep", '10'="Oct", '11'="Nov", '12'="Dec"))

label.position.months.perc = rep(7, times=36)
label.position.months.bold =  rep(7, times=48)

# boldness plot PERCENTAGES 
bold.months.plot = 
  ggplot(bold.months, aes(x = Month, y = perc,  fill=Bold))+
  geom_col()+ 
  theme_bw()+
    scale_fill_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1)+ 
        ylab("Percentage of Classifiable Reports")+ 
  scale_y_continuous(expand = c(0.01, 0.01)) + geom_vline(xintercept= c(4.5,8.5), linetype = 2)+
  geom_text(aes(x=Month, y = label.position.months.bold,  label=total), vjust=1, size = 6, color="white") + 
  geom_text(label = "Breeding", x=2.5, y = 97, size = 5)+
  geom_text(label = "Pup Rearing", x=6.55, y = 97, size = 5)+
  geom_text(label = "Dispersal", x=10.5, y = 97, size = 5)+
  theme(axis.title = element_text(size = 17),axis.text = element_text(size = 15),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(),
       legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))
# Perceptions plot PERCENTAGES
perc.months.plot = 
  ggplot(perc.months, aes(x = Month, y = perc, fill=HumanPerception))+
   geom_col() + 
  theme_bw()+
  scale_fill_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1)+ 
  ylab("Percentage of Classifiable Reports")+ 
  scale_y_continuous(expand = c(0.01, 0.01)) + geom_vline(xintercept= c(4.5,8.5), linetype = 2)+
  geom_text(aes(x=Month, y = label.position.months.perc,  label=total), vjust=1, size = 6, color="white") + 
  geom_text(label = "Breeding", x=2.5, y = 97, size = 5)+
  geom_text(label = "Pup Rearing", x=6.55, y = 97, size = 5)+
  geom_text(label = "Dispersal", x=10.5, y = 97, size = 5)+
  theme(axis.title = element_text(size = 17), axis.text.x = element_text(size = 15, angle = 45, hjust = 1), 
        axis.text.y=element_text(size = 15),
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.ticks = element_blank(),
        legend.position = "right") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))

cowplot::plot_grid( bold.months.plot, perc.months.plot, ncol = 1, align = "v")

rm(perc.months.plot, bold.months.plot, bold.months, perc.months,label.position.months.perc, label.position.months.bold )
```

Boldness & Perceptions over diel scales
```{r}
# making a data frame with percentages per month for BOLDNESS 
bold.diurnal = Coyotes %>%  filter(Bold!="unk", Bold!="sight")%>%
  group_by(NightDay, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         Bold = recode(Bold, avoid = "Avoidance", indiff = "Indifferent", bold= "Bold", aggress = "Aggressive"))

# making a data frame with percentages of human perceptions per month
perc.diurnal = Coyotes %>% filter(HumanPerception !="Concern", HumanPerception!="Unknown")%>%
  group_by(NightDay, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) %>%
  mutate(HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")))

label.position.diurnal.bold = rep(99, times=12)
label.position.diurnal.perc = rep(99, times=9)


# boldness plot PERCENTAGES 
bold.diurnal.plot = 
  ggplot(bold.diurnal, aes(x = NightDay, y = perc,  fill=Bold))+
  geom_col()+ 
  theme_bw()+
    scale_fill_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1)+ 
        ylab("% of classifiable reports")+ xlab(NULL)+
  scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=NightDay, y = label.position.diurnal.bold,  label=total), vjust=1, size = 6) + 
  theme(axis.title = element_text(size = 20),axis.text = element_text(size = 15),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(),
       legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))
# Perceptions plot PERCENTAGES
perc.diurnal.plot = 
  ggplot(perc.diurnal, aes(x = NightDay, y = perc, fill=HumanPerception))+
   geom_col() + 
  theme_bw()+
  scale_fill_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1)+ 
  ylab("% of classifiable reports")+
  geom_text(aes(x=NightDay, y = label.position.diurnal.perc,  label=total), vjust=1, size = 6) + 
  scale_y_continuous(expand = c(0.01, 0.01)) + xlab(NULL)+
  theme(axis.title = element_text(size = 20), axis.text.x = element_text(size = 15), 
        axis.text.y=element_text(size = 15),
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "right") + 
  guides(fill = guide_legend(title.position = "top", title.hjust = 0.5))

cowplot::plot_grid( bold.diurnal.plot, perc.diurnal.plot, ncol = 1, align = "v")


rm(perc.diurnal.plot, bold.diurnal.plot, bold.diurnal, perc.diurnal,label.position.diurnal.perc, label.position.diurnal.bold )

```

### Contextual Patterns in Boldness & Human Perceptions

Human activity 
```{r}
# making a data frame with percentages per month for BOLDNESS 
bold.act = Coyotes %>%  filter(Bold!="unk", Bold!="sight")%>%
  group_by(HumanActivity, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         Bold = recode(Bold, avoid = "Avoidance", indiff = "Indifferent", bold= "Bold", aggress = "Aggressive")) 

bold.act$HumanActivity = fct_relevel(bold.act$HumanActivity, c("Cycling", "OutdoorAct", "Walking", "Driving", "HomeYard", "Unknown"))

# making a data frame with percentages of human perceptions per month
perc.act = Coyotes %>% filter(HumanPerception !="Concern", HumanPerception!="Unknown")%>%
  group_by(HumanActivity, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) %>%
  mutate(HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")))

perc.act$HumanActivity = fct_relevel(perc.act$HumanActivity, c("Cycling", "OutdoorAct", "Walking", "Driving", "HomeYard", "Unknown"))

label.position.act.perc = rep(6, times=18)
label.position.act.bold = rep(6, times=24)


# boldness plot PERCENTAGES 
bold.act.plot = 
  ggplot(bold.act, aes(x = HumanActivity, y = perc,  fill=Bold))+
  geom_col()+ 
  theme_bw()+
    scale_fill_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1)+ 
        ylab("Percentage of Classifiable Reports")+ 
  scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=HumanActivity, y = label.position.act.bold,  label=total), vjust=1, size = 6, color = "white") + 
  theme(axis.title = element_text(size = 17),axis.text = element_text(size = 15),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 
# Perceptions plot PERCENTAGES
perc.act.plot = 
  ggplot(perc.act, aes(x = HumanActivity, y = perc, fill=HumanPerception))+
   geom_col() + 
  theme_bw()+
  scale_fill_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1)+ 
  ylab("Percentage of Classifiable Reports") + xlab("Human Activity")+
  geom_text(aes(x=HumanActivity, y = label.position.act.perc,  label=total), vjust=1, size = 6, color="white") + 
  scale_y_continuous(expand = c(0.01, 0.01)) +
  theme(axis.title = element_text(size = 17), axis.text.x = element_text(size = 15, angle = 45, hjust=1), 
        axis.text.y=element_text(size = 15),axis.ticks = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 

```

Vulnerable Individuals
```{r}
# making a data frame with percentages per month for BOLDNESS 
bold.vul = Coyotes %>%  filter(Bold!="unk", Bold!="sight")%>%
  group_by(VulnerableIndividual, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         Bold = recode(Bold, avoid = "Avoidance", indiff = "Indifferent", bold= "Bold", aggress = "Aggressive")) 

# making a data frame with percentages of human perceptions per month
perc.vul = Coyotes %>% filter(HumanPerception !="Concern", HumanPerception!="Unknown")%>%
  group_by(VulnerableIndividual, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) %>%
  mutate(HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")))

label.position.vul.bold = rep(6, times=20)
label.position.vul.perc = rep(6, times=15)

# boldness plot PERCENTAGES 
bold.vul.plot = 
  ggplot(bold.vul, aes(x = VulnerableIndividual, y = perc,  fill=Bold))+
  geom_col()+ 
  theme_bw()+
    scale_fill_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1)+ 
        ylab("% of classifiable reports")+
  scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=VulnerableIndividual, y = label.position.vul.bold,  label=total), vjust=1, size = 6, color = "white") + 
  theme(axis.title = element_text(size = 20),axis.text = element_text(size = 15),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(),
        axis.title.y=element_blank(),axis.text.y = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 
# Perceptions plot PERCENTAGES
perc.vul.plot = 
  ggplot(perc.vul, aes(x = VulnerableIndividual, y = perc, fill=HumanPerception))+
   geom_col() + 
  theme_bw()+
  scale_fill_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1)+ 
  ylab("% of classifiable reports")+xlab("Vulnerable Individual")+
  geom_text(aes(x=VulnerableIndividual, y = label.position.vul.perc,  label=total), vjust=1, size = 6, color = "white") + 
  scale_y_continuous(expand = c(0.01, 0.01)) + 
  theme(axis.title.x = element_text(size = 20), axis.text.x = element_text(size = 15, angle = 45, hjust=1), 
        axis.title.y=element_blank(), axis.text.y = element_blank(),axis.ticks = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 
```

Coyote Number
```{r}
# making a data frame with percentages per month for BOLDNESS 
bold.num = Coyotes %>%  filter(Bold!="unk", Bold!="sight")%>%
  group_by(CoyoteNumber, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         Bold = recode(Bold, avoid = "Avoidance", indiff = "Indifferent", bold= "Bold", aggress = "Aggressive")) 

bold.num$CoyoteNumber = fct_relevel(bold.num$CoyoteNumber, c("One", "Two", "Three", "More", "Unknown"))

# making a data frame with percentages of human perceptions per month
perc.num = Coyotes %>% filter(HumanPerception !="Concern", HumanPerception!="Unknown")%>%
  group_by(CoyoteNumber, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) %>%
  mutate(HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative")))

perc.num$CoyoteNumber = fct_relevel(perc.num$CoyoteNumber, c("One", "Two", "Three", "More", "Unknown"))

label.position.num.bold = rep(6, times=20)
label.position.num.perc = rep(6, times=15)

# boldness plot PERCENTAGES 
bold.num.plot = 
  ggplot(bold.num, aes(x = CoyoteNumber, y = perc,  fill=Bold))+
  geom_col()+ 
  theme_bw()+
    scale_fill_viridis("Coyote Boldness", discrete=TRUE, option = "inferno", direction = -1)+ 
        ylab("% of classifiable reports")+
  scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=CoyoteNumber, y = label.position.num.bold,  label=total), vjust=1, size = 6, color = "white") + 
  theme(axis.title = element_text(size = 20),axis.text = element_text(size = 15),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(),
        axis.title.y=element_blank(),axis.text.y = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 
# Perceptions plot PERCENTAGES
perc.num.plot = 
  ggplot(perc.num, aes(x = CoyoteNumber, y = perc, fill=HumanPerception))+
   geom_col() + 
  theme_bw()+
  scale_fill_viridis("Human Perception", discrete=TRUE, option = "magma", direction = -1)+ 
  ylab("% of classifiable reports")+xlab("Number of Coyotes")+
  geom_text(aes(x=CoyoteNumber, y = label.position.num.perc,  label=total), vjust=1, size = 6, color = "white") + 
  scale_y_continuous(expand = c(0.01, 0.01)) + 
  theme(axis.title.x = element_text(size = 20), axis.text.x = element_text(size = 15, angle = 45, hjust=1), 
        axis.title.y=element_blank(), axis.text.y = element_blank(),axis.ticks = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.position = "none") 
```

Coyote Health
```{r}
# making a data frame with percentages per month for BOLDNESS 
bold.health = Coyotes %>%  filter(Bold!="unk", Bold!="sight")%>%
  group_by(Health, Bold) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count), 
         Bold = recode(Bold, avoid = "Avoidance", indiff = "Indifferent", bold= "Bold", aggress = "Aggressive")) %>%
  mutate(Health = fct_relevel(Health, c("Healthy", "Unhealthy","Unknown"))) 

# making a data frame with percentages of human perceptions per month
perc.health = Coyotes %>% filter(HumanPerception !="Concern", HumanPerception!="Unknown")%>%
  group_by(Health, HumanPerception) %>%
  summarise(count=n())%>%
  mutate(perc = count/sum(count)*100, 
         total = sum(count)) %>%
  mutate(HumanPerception = fct_relevel(HumanPerception, c("Positive", "Neutral", "Negative"))) %>%
  mutate(Health = fct_relevel(Health, c("Healthy", "Unhealthy","Unknown")))

label.position.health.perc = rep(6, times=9)
label.position.health.bold = rep(6, times=12)

# boldness plot PERCENTAGES 
bold.health.plot = 
  ggplot(bold.health, aes(x = Health, y = perc,  fill=Bold))+
  geom_col()+ 
  theme_bw()+
    scale_fill_viridis("Coyote\nBoldness", discrete=TRUE, option = "inferno", direction = -1)+ 
        ylab("% of classifiable reports")+
  scale_y_continuous(expand = c(0.01, 0.01)) +
  geom_text(aes(x=Health, y = label.position.health.bold,  label=total), vjust=1, size = 6, color = "white") + 
  theme(axis.title = element_text(size = 20),axis.text = element_text(size = 15),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks = element_blank(),
        axis.title.y=element_blank(),axis.text.y = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),       
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        legend.position = "right") + 
  guides(fill = guide_legend(title.position = "top")) 
# Perceptions plot PERCENTAGES
perc.health.plot = 
  ggplot(perc.health, aes(x = Health, y = perc, fill=HumanPerception))+
   geom_col() + 
  theme_bw()+
  scale_fill_viridis("Human\nPerception", discrete=TRUE, option = "magma", direction = -1)+ 
  ylab("% of classifiable reports")+xlab("Coyote Health")+
  geom_text(aes(x=Health, y = label.position.health.perc,  label=total), vjust=1, size = 6, color = "white") + 
  scale_y_continuous(expand = c(0.01, 0.01)) + 
  theme(axis.title.x = element_text(size = 20), axis.text.x = element_text(size = 15, angle = 45, hjust=1), 
        axis.title.y=element_blank(), axis.text.y = element_blank(),axis.ticks = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.title = element_text(size = 20), legend.text = element_text(size = 15), legend.key.size = unit(1, 'cm'), 
        legend.position = "right") + 
  guides(fill = guide_legend(title.position = "top"))

```


Plot all contextual variables together 
```{r}
  ggdraw()+
  draw_plot(bold.act.plot, x= 0, y = 0.57, width =0.28, height =.43)+ 
  draw_plot(perc.act.plot, x= 0, y = 0, width =0.28, height =.57) +
  draw_plot(bold.vul.plot, x= 0.28, y = 0.57, width =0.22, height =.43) +
  draw_plot(perc.vul.plot, x= 0.28, y = 0, width =0.22, height =.57) +
  draw_plot(bold.num.plot, x= 0.5, y = 0.57, width =.25, height =.43) + 
  draw_plot(perc.num.plot, x= 0.5, y = 0, width =.25, height =.57) +
  draw_plot(bold.health.plot, x= 0.75, y = 0.57, width =.25, height =.43) + 
  draw_plot(perc.health.plot, x= 0.75, y = 0, width =.24, height =.57) 

```

## Correlations between contextual variables (and time of day & season) for correlation table
```{r}

# Correlations between vulnerable individual and other variables
chisq.test(Coyotes$VulnerableIndividual, Coyotes$HumanActivity) # significant correlation
chisq.test(Coyotes$VulnerableIndividual, Coyotes$Health) # significant correlation
chisq.test(Coyotes$VulnerableIndividual, Coyotes$CoyoteNumber) # significant correlation

# Correlations between Human activity and other variables
chisq.test(Coyotes$HumanActivity, Coyotes$Health) # significant correlation
chisq.test(Coyotes$HumanActivity, Coyotes$CoyoteNumber) # significant correlation

# Correlation between health & coyote number
chisq.test(Coyotes$Health, Coyotes$CoyoteNumber) # significant correlation

# Time of day and season are also serially correlated (why we excluded time of day from real models)
chisq.test(Coyotes$NightDay, Coyotes$Season) # significant correlation

```


# Simple summary chi square tests: looking for differences between categorical variables in univariate tests

## Coyote boldness

Coyote boldness across habitat types 
```{r}
bold.hab.table = table(bold.data$Bold, bold.data$Habitat)

corrplot(chisq.test(bold.hab.table[3:6,])$residuals, is.cor=FALSE, method = "circle") # visualizing chisqu residuals

bold.hab.chsq = chisq.test(bold.hab.table[3:6,]) # oh my, significant differences! 

bold.hab.chsq.resids = chisq.posthoc.test(bold.hab.table[3:6,], method="bonferroni", round = 3)

bold.hab.chsq.resids
bold.hab.table



ComMod_chsq = chisq.test(bold.hab.table[3:6, 1:2]) # commercial and modified open 
ComMow_chsq = chisq.test(bold.hab.table[3:6, c(1,3)]) # commercial and mowed 
ComNat_chsq = chisq.test(bold.hab.table[3:6, c(1,4)]) # commercial and natural
ComRes_chsq = chisq.test(bold.hab.table[3:6, c(1,5)]) # commercial and residential 
ModMow_chsq = chisq.test(bold.hab.table[3:6, 2:3]) # modified open and mowed
ModNat_chsq = chisq.test(bold.hab.table[3:6, c(2,4)]) # modified open and natural
ModRes_chsq = chisq.test(bold.hab.table[3:6, c(2,5)]) # modified open and residential
MowNat_chsq = chisq.test(bold.hab.table[3:6, 3:4]) # mowed and natural
MowRes_chsq = chisq.test(bold.hab.table[3:6, c(3,5)]) # mowed and residential
NatRes_chsq = chisq.test(bold.hab.table[3:6, c(4,5)]) # natural and residential

# Making a data frame with xsq stats, degrees of freedom, and p values
bold.hab_chsq_output = data.frame(row.names = c("Com_Mod", "Com_Mow", "Com_Nat", "Com_Res", 
                                       "Mod_Mow", "Mod_Nat", "Mod_Res",
                                       "Mow_Nat", "Mow_Res", 
                                       "Nat_Res"), 
                         Xsq = c(ComMod_chsq$statistic, ComMow_chsq$statistic, ComNat_chsq$statistic, ComRes_chsq$statistic,
                                 ModMow_chsq$statistic, ModNat_chsq$statistic , ModRes_chsq$statistic, 
                                 MowNat_chsq$statistic, MowRes_chsq$statistic, 
                                 NatRes_chsq$statistic), 
                         df = c(ComMod_chsq$parameter, ComMow_chsq$parameter, ComNat_chsq$parameter, ComRes_chsq$parameter,
                                 ModMow_chsq$parameter, ModNat_chsq$parameter , ModRes_chsq$parameter, 
                                 MowNat_chsq$parameter, MowRes_chsq$parameter, 
                                 NatRes_chsq$parameter), 
                         p =  c(ComMod_chsq$p.value, ComMow_chsq$p.value, ComNat_chsq$p.value, ComRes_chsq$p.value,
                                 ModMow_chsq$p.value, ModNat_chsq$p.value , ModRes_chsq$p.value, 
                                 MowNat_chsq$p.value, MowRes_chsq$p.value, 
                                 NatRes_chsq$p.value))

rm(bold.hab.table, ComMod_chsq, ComMow_chsq, ComNat_chsq, ComRes_chsq, ModMow_chsq, ModNat_chsq, ModRes_chsq, MowNat_chsq, MowRes_chsq, NatRes_chsq)

```

Coyote boldness across seasons
```{r}
bold.szn.table = table(bold.data$Bold, bold.data$Season)

corrplot(chisq.test(bold.szn.table[3:6,])$residuals, is.cor=FALSE, method = "circle") # visualizing chisqu residuals

BrePup_chsq = chisq.test(bold.szn.table[3:6, c(1,3)]) # breeding and pup rearing
BreDis_chsq = chisq.test(bold.szn.table[3:6,c(1,2)]) # breeding and dispersal
PupDis_chsq = chisq.test(bold.szn.table[3:6,c(2,3)]) # pup rearing and dispersal

# Making a data frame with xsq stats, degrees of freedom, and p values
bold.szn_chsq_output = data.frame(row.names = c("Bre_Pup", "Bre_Dis", "Pup_Dis"), 
                         Xsq = c(BrePup_chsq$statistic, BreDis_chsq$statistic, PupDis_chsq$statistic), 
                         df = c(BrePup_chsq$parameter, BreDis_chsq$parameter, PupDis_chsq$parameter), 
                         p =  c(BrePup_chsq$p.value, BreDis_chsq$p.value, PupDis_chsq$p.value))

rm(bold.szn.table, BrePup_chsq, BreDis_chsq, PupDis_chsq)

```

Coyote boldness across time of day
```{r}
bold.diel.table = table(bold.data$Bold, bold.data$NightDay)

corrplot(chisq.test(bold.diel.table[3:6,])$residuals, is.cor=FALSE, method = "circle") # visualizing chisqu residuals

Diel_chsq = chisq.test(bold.diel.table[3:6, c(1,2)]) # comparing night and day

# Making a data frame with xsq stats, degrees of freedom, and p values
bold.diel_chsq_output = data.frame(row.names = c("Night_Day"), 
                         Xsq = c(Diel_chsq$statistic), 
                         df = c(Diel_chsq$parameter), 
                         p =  c(Diel_chsq$p.value))

rm(bold.diel.table, Diel_chsq)
```

Coyote boldness across human activity
```{r}
bold.act.table = table(Coyotes$Bold, Coyotes$HumanActivity) # make a table

bold.act.chsq = chisq.test(bold.act.table[3:6,c(1, 2,3,4,6)]) # run a chi square test
bold.act.chsq$expected

bold.act.chsq.resids = chisq.posthoc.test(bold.act.table[3:6,c(1, 2,3,4,5,6)], method = "holm") # run a posthoc test


# formatting a new data frame
bold.act.chsq.resids.long = pivot_longer(bold.act.chsq.resids, cols = c(Cycling, Driving, HomeYard, OutdoorAct,Unknown, Walking))
bold.act.chsq.resids.long = data.frame(Bold = subset(bold.act.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Act =  subset(bold.act.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(bold.act.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(bold.act.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))), 
         Bold = fct_relevel(Bold, "Avoidance", "Indifferent", "Bold", "Aggressive"), 
         Act = fct_relevel(Act, "Driving", "Cycling", "HomeYard", "Walking", "OutdoorAct", "Unknown")) 


bold.act.chsq.resids.long$Bold = factor(bold.act.chsq.resids.long$Bold, labels = c("Avoid.", "Indiff.", "Bold", "Aggres."))

# plotting! 
bold.act.chsq.plot = 
ggplot(bold.act.chsq.resids.long, aes(y = Act, x = Bold, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 6, color = "grey30") + 
  #scale_fill_viridis(option = "turbo", direction = -1,limits = c(-20,20)) + 
  scale_fill_distiller("Residuals",palette = "RdYlBu", na.value = "grey80", limits =c(-11,19), breaks=c(-10,0,18), labels=c(-10, 0,18),  direction=1)+ 
  ylab("Human\nActivity") + xlab("Coyote Boldness") + 
  theme_bw()+   
  scale_x_discrete(expand =c(0,0), position = "top")+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none", 
        axis.ticks = element_blank(), axis.text.x = element_text(size = 16),
        axis.text.y = element_text(size = 16), axis.title = element_text(size = 18),
        panel.grid = element_blank()) 


```

Coyote boldness across vulnerable individuals
```{r}
bold.vul.table = table(Coyotes$Bold, Coyotes$VulnerableIndividual) # make a table

bold.vul.chsq = chisq.test(bold.vul.table[3:6,1:4]) # run a chi square test
bold.vul.chsq

bold.vul.chsq.resids = chisq.posthoc.test(bold.vul.table[3:6,1:5], method = "holm") # run a posthoc test


# formatting a new data frame
bold.vul.chsq.resids.long = pivot_longer(bold.vul.chsq.resids, cols = c(Cat, Child, Dog, Multiple, Unknown))
bold.vul.chsq.resids.long = data.frame(Bold = subset(bold.vul.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Vul =  subset(bold.vul.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(bold.vul.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(bold.vul.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))), 
         Bold = fct_relevel(Bold, "Avoidance", "Indifferent", "Bold", "Aggressive")) 

# plotting! 
bold.vul.chsq.plot = 
ggplot(bold.vul.chsq.resids.long, aes(y = Vul, x = Bold, fill = Resids)) +
  geom_tile() + geom_text(size = 6, color = "grey30", aes(label = sig)) + 
  #scale_fill_viridis(option = "turbo", direction = -1, limits = c(-20,20)) +
 scale_fill_distiller("Residuals",palette = "RdYlBu", na.value = "grey80", limits =c(-18,18.5), direction=1)+ 
  ylab("Vulnerable\nIndividuals") + xlab(NULL)+
  theme_bw()+ 
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none", 
        axis.text.x = element_blank(), 
        axis.text.y = element_text(size = 16), axis.title.y = element_text(size = 18),
        axis.ticks = element_blank(), 
        panel.grid = element_blank()) 

```

Coyote boldness across dog leash status
```{r}
bold.leash.table = table(Coyotes$Bold, Coyotes$DogPresent) # make a table

bold.leash.chsq = chisq.test(bold.leash.table[3:6,2:4]) # run a chi square test
bold.leash.chsq.resids = chisq.posthoc.test(bold.leash.table[3:6, 2:4], method = "holm") # run a posthoc test

bold.leash.chsq$expected
# formatting a new data frame
bold.leash.chsq.resids.long = pivot_longer(bold.leash.chsq.resids, cols = c(Leashed, OffLeash, Unknown))
bold.leash.chsq.resids.long = data.frame(Bold = subset(bold.leash.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Leash =  subset(bold.leash.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(bold.leash.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(bold.leash.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Bold = fct_relevel(Bold, "Avoidance", "Indifferent", "Bold", "Aggressive")) 


summary(perc.leash.chsq.resids.long$Resids)
# plotting! 
bold.leash.chsq.plot=
  ggplot(bold.leash.chsq.resids.long, aes(y = Leash, x = Bold, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 6, color="grey30") + ylab("Leash\nStatus") + xlab(NULL)+
  scale_fill_distiller("Residuals",palette = "RdYlBu", na.value = "grey80", limits =c(-10,11), breaks  = c(-10,0,10), labels = c(-10,0,10), direction=1)+ 
  #scale_fill_viridis(option = "turbo", direction = -1, limits = c(-20,20)) +
  theme_bw() + 
    scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none", 
        axis.text.x = element_blank(), 
        axis.text.y = element_text(size = 16), axis.title.y = element_text(size = 18), 
        axis.ticks = element_blank(), 
        panel.grid = element_blank())
```

Coyote boldness across number of coyotes
```{r}
bold.num.table = table(Coyotes$Bold, Coyotes$CoyoteNumber) # make a table

bold.num.chsq = chisq.test(bold.num.table[3:6,1:5]) # run a chi square test
bold.num.chsq

bold.num.chsq.resids = chisq.posthoc.test(bold.num.table[3:6,1:5], method = "holm") # run a posthoc test


# formatting a new data frame
bold.num.chsq.resids.long = pivot_longer(bold.num.chsq.resids, cols = c(More, One, Three, Two, Unknown))
bold.num.chsq.resids.long = data.frame(Bold = subset(bold.num.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Num =  subset(bold.num.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(bold.num.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(bold.num.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))), 
         Bold = fct_relevel(Bold, "Avoidance", "Indifferent", "Bold", "Aggressive"), 
         Num  = fct_relevel(Num, "One", "Two", "Three", "More", "Unknown")) 

# plotting! 
bold.num.chsq.plot = 
ggplot(bold.num.chsq.resids.long, aes(y = Num, x = Bold, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 6, color = "grey30") + 
 # scale_fill_viridis(option = "turbo", direction = -1, limits = c(-20,20)) +
  ylab("Coyote\nNumber") + xlab(NULL) + 
   scale_fill_distiller(palette = "RdYlBu", na.value = "grey80", limits =c(-7,7.5), breaks = c(-7,0,7), labels = c(-7, 0, 7), direction=1)+ 
  theme_bw() + 
    scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none", 
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 16), axis.title.y = element_text(size = 18),
        axis.ticks = element_blank(), 
        panel.grid = element_blank())

```

Coyote boldness across coyote health
```{r}
bold.health.table = table(Coyotes$Bold, Coyotes$Health) # make a table

bold.health.chsq = chisq.test(bold.health.table[3:6,1:3]) # run a chi square test
bold.health.chsq$expected

bold.health.chsq.resids = chisq.posthoc.test(bold.health.table[3:6,1:3], method = "holm") # run a posthoc test


# formatting a new data frame
bold.health.chsq.resids.long = pivot_longer(bold.health.chsq.resids, cols = c(Unknown, Unhealthy, Healthy))
bold.health.chsq.resids.long = data.frame(Bold = subset(bold.health.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Health =  subset(bold.health.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(bold.health.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(bold.health.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))), 
         Bold = fct_relevel(Bold, "Avoidance", "Indifferent", "Bold", "Aggressive"), 
         Health  = fct_relevel(Health, "Healthy", "Unhealthy", "Unknown")) 

# plotting! 
bold.health.chsq.plot = 
ggplot(bold.health.chsq.resids.long, aes(y = Health, x = Bold, fill = Resids)) +
  geom_tile()+ geom_text(aes(label = sig), size = 6, color = "grey30") + ylab("Coyote\nHealth") + xlab(NULL) + 
  #scale_fill_viridis("Residuals", option = "turbo", direction = -1, limits = c(-20,20)) + 
   scale_fill_distiller(palette = "RdYlBu", na.value = "grey80", limits =c(-11,12.5), breaks = c(-11,0,12), labels = c(-11, 0, 12), direction=1)+ 
  theme_bw() + 
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme( axis.text.x = element_blank(),
        axis.text.y = element_text(size = 16), axis.title.y = element_text(size = 18),
        axis.ticks = element_blank(), 
        panel.grid = element_blank(), 
        legend.position = "none") 

```

## Human Perceptions

Human Perceptions across habitat types 
```{r}
perc.hab.table = table(perc.data$HumanPerception, perc.data$Habitat)

corrplot(chisq.test(perc.hab.table)$residuals, is.cor=FALSE, method = "circle") # visualizing chisqu residuals

ComMod_chsq = chisq.test(perc.hab.table[, 1:2]) # commercial and modified open 
ComMow_chsq = chisq.test(perc.hab.table[, c(1,3)]) # commercial and mowed 
ComNat_chsq = chisq.test(perc.hab.table[, c(1,4)]) # commercial and natural
ComRes_chsq = chisq.test(perc.hab.table[, c(1,5)]) # commercial and residential 
ModMow_chsq = chisq.test(perc.hab.table[, 2:3]) # modified open and mowed
ModNat_chsq = chisq.test(perc.hab.table[, c(2,4)]) # modified open and natural
ModRes_chsq = chisq.test(perc.hab.table[, c(2,5)]) # modified open and residential
MowNat_chsq = chisq.test(perc.hab.table[, 3:4]) # mowed and natural
MowRes_chsq = chisq.test(perc.hab.table[, c(3,5)]) # mowed and residential
NatRes_chsq = chisq.test(perc.hab.table[, c(4,5)]) # natural and residential

# Making a data frame with xsq stats, degrees of freedom, and p values
perc.hab_chsq_output = data.frame(row.names = c("Com_Mod", "Com_Mow", "Com_Nat", "Com_Res", 
                                       "Mod_Mow", "Mod_Nat", "Mod_Res",
                                       "Mow_Nat", "Mow_Res", 
                                       "Nat_Res"), 
                         Xsq = c(ComMod_chsq$statistic, ComMow_chsq$statistic, ComNat_chsq$statistic, ComRes_chsq$statistic,
                                 ModMow_chsq$statistic, ModNat_chsq$statistic , ModRes_chsq$statistic, 
                                 MowNat_chsq$statistic, MowRes_chsq$statistic, 
                                 NatRes_chsq$statistic), 
                         df = c(ComMod_chsq$parameter, ComMow_chsq$parameter, ComNat_chsq$parameter, ComRes_chsq$parameter,
                                 ModMow_chsq$parameter, ModNat_chsq$parameter , ModRes_chsq$parameter, 
                                 MowNat_chsq$parameter, MowRes_chsq$parameter, 
                                 NatRes_chsq$parameter), 
                         p =  c(ComMod_chsq$p.value, ComMow_chsq$p.value, ComNat_chsq$p.value, ComRes_chsq$p.value,
                                 ModMow_chsq$p.value, ModNat_chsq$p.value , ModRes_chsq$p.value, 
                                 MowNat_chsq$p.value, MowRes_chsq$p.value, 
                                 NatRes_chsq$p.value))

rm(perc.hab.table, ComMod_chsq, ComMow_chsq, ComNat_chsq, ComRes_chsq, ModMow_chsq, ModNat_chsq, ModRes_chsq, MowNat_chsq, MowRes_chsq, NatRes_chsq)

```

Human Perceptions across seasons
```{r}
perc.szn.table = table(perc.data$HumanPerception, perc.data$Season)

corrplot(chisq.test(perc.szn.table)$residuals, is.cor=FALSE, method = "circle") # visualizing chisqu residuals

BrePup_chsq = chisq.test(perc.szn.table[, c(1,3)]) # breeding and pup rearing
BreDis_chsq = chisq.test(perc.szn.table[,c(1,2)]) # breeding and dispersal
PupDis_chsq = chisq.test(perc.szn.table[,c(2,3)]) # pup rearing and dispersal

# Making a data frame with xsq stats, degrees of freedom, and p values
perc.szn_chsq_output = data.frame(row.names = c("Bre_Pup", "Bre_Dis", "Pup_Dis"), 
                         Xsq = c(BrePup_chsq$statistic, BreDis_chsq$statistic, PupDis_chsq$statistic), 
                         df = c(BrePup_chsq$parameter, BreDis_chsq$parameter, PupDis_chsq$parameter), 
                         p =  c(BrePup_chsq$p.value, BreDis_chsq$p.value, PupDis_chsq$p.value))

rm(perc.szn.table, BrePup_chsq, BreDis_chsq, PupDis_chsq)

```

Human Perceptions across time of day
```{r}
perc.diel.table = table(perc.data perc.data$NightDay)

Diel_chsq = chisq.test(perc.diel.table[, c(1,2)]) # comparing night and day

# Making a data frame with xsq stats, degrees of freedom, and p values
perc.diel_chsq_output = data.frame(row.names = c("Night_Day"), 
                         Xsq = c(Diel_chsq$statistic), 
                         df = c(Diel_chsq$parameter), 
                         p =  c(Diel_chsq$p.value))

rm(perc.diel.table, Diel_chsq)
```

Human Perceptions across human activity
```{r}
perc.act.table = table(Coyotes$HumanPerception, Coyotes$HumanActivity) # make a table

perc.act.chsq = chisq.test(perc.act.table[2:4,c(2,3,5,6)]) # run a chi square test
perc.act.chsq$expected # need to remove cycling and outdoor activity because expected chi square is less than 5

perc.act.chsq.resids = chisq.posthoc.test(perc.act.table[2:4,c(2,3,5,6)], method = "holm") # run a posthoc test

# formatting a new data frame
perc.act.chsq.resids.long = pivot_longer(perc.act.chsq.resids, cols = c(Driving, HomeYard, Unknown, Walking))
perc.act.chsq.resids.long = data.frame(Perc = subset(perc.act.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Act =  subset(perc.act.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(perc.act.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(perc.act.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Perc = fct_relevel(Perc, "Positive", "Neutral", "Negative")) 

# add in 6 rows, with each of 
perc.act.chsq.resids.long = 
  rbind(perc.act.chsq.resids.long, data.frame(Perc = c("Positive", "Neutral", "Negative", "Positive", "Neutral", "Negative"),
                                       Act =  c("Cycling","Cycling","Cycling","OutdoorAct", "OutdoorAct", "OutdoorAct"), 
                                       Resids = NA, 
                                       Pval = 0,
                                       sig = "NA"))

perc.act.chsq.resids.long$Act = fct_relevel(perc.act.chsq.resids.long$Act, 
                                            "Driving", "Cycling", "HomeYard", "Walking","OutdoorAct", "Unknown")



summary(bold.act.chsq.resids.long$Resids)
# plotting!
perc.act.chsq.plot=
ggplot(perc.act.chsq.resids.long, aes(y = Act, x = Perc, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 6, color="grey30") + 
  #scale_fill_viridis("Residuals", option = "turbo", direction = -1,limits = c(-15,15)) +
   scale_fill_distiller("Residuals", palette = "RdYlBu", na.value = "grey80", limits =c(-11,19), breaks=c(-10,0,18), labels=c(-10, 0, 18), direction=1)+ 
  xlab("Human Perception") + ylab(NULL) + 
  scale_x_discrete(expand =c(0,0), position = "top")+ scale_y_discrete(expand = c(0,0))+
  theme_bw()+ 
  theme(legend.position = "right", 
        axis.text.x = element_text(size = 16), axis.title= element_text(size = 18),
        axis.text.y = element_blank(), 
        axis.ticks = element_blank(),
        legend.text = element_text(size = 14), legend.title = element_blank(), 
        panel.grid = element_blank()) + 
    guides(fill = guide_colourbar(ticks = FALSE))


```

Human Perceptions across vulnerable individuals
```{r}
perc.vul.table = table(Coyotes$HumanPerception, Coyotes$VulnerableIndividual) # make a table

perc.vul.chsq = chisq.test(perc.vul.table[2:4,1:5]) # run a chi square test

perc.vul.chsq.resids = chisq.posthoc.test(perc.vul.table[2:4,1:5], method = "holm") # run a posthoc test


# formatting a new data frame
perc.vul.chsq.resids.long = pivot_longer(perc.vul.chsq.resids, cols = c(Cat, Child, Dog, Multiple, Unknown))
perc.vul.chsq.resids.long = data.frame(Perc = subset(perc.vul.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Vul =  subset(perc.vul.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(perc.vul.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(perc.vul.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Perc = fct_relevel(Perc, "Positive", "Neutral", "Negative")) 


summary(bold.vul.chsq.resids.long$Resids)
# plotting! 
perc.vul.chsq.plot =
ggplot(perc.vul.chsq.resids.long, aes(y = Vul, x = Perc, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 6, color = "grey30") + 
 # scale_fill_viridis(option = "turbo", direction = -1,limits = c(-15,15)) +
  ylab(NULL)+ xlab(NULL)+
 scale_fill_distiller("Residuals",palette = "RdYlBu", na.value = "grey80", breaks=c(-18,0,18), labels=c(-18, 0,18), limits = c(-18, 18.5), direction=1)+ 
   theme_bw()+ 
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.position = "right",
        legend.text = element_text(size = 14), legend.title = element_blank(), 
        panel.grid = element_blank()) + 
    guides(fill = guide_colourbar(ticks = FALSE))



```

Human Perceptions across dog leash status
```{r}
perc.leash.table = table(Coyotes$HumanPerception, Coyotes$DogPresent) # make a table

perc.leash.chsq = chisq.test(perc.leash.table[2:4, 2:4]) # run a chi square test
perc.leash.chsq.resids = chisq.posthoc.test(perc.leash.table[2:4,2:4], method = "holm") # run a posthoc test


# formatting a new data frame
perc.leash.chsq.resids.long = pivot_longer(perc.leash.chsq.resids, cols = c(Leashed, OffLeash, Unknown))
perc.leash.chsq.resids.long = data.frame(Perc = subset(perc.leash.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Leash =  subset(perc.leash.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(perc.leash.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(perc.leash.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
          Perc = fct_relevel(Perc, "Positive", "Neutral", "Negative")) 

# plotting! 
perc.leash.chsq.plot=
  ggplot(perc.leash.chsq.resids.long, aes(y = Leash, x = Perc, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 6, color="grey30") + ylab(NULL) + xlab(NULL)+
 # scale_fill_viridis(option = "turbo", direction = -1,limits = c(-15,15)) + 
  scale_fill_distiller(palette = "RdYlBu", na.value = "grey80",  limits =c(-10,11), breaks  = c(-9,0,10), labels = c(-9,0,10), direction=1)+ 
  theme_bw() + 
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(axis.text = element_blank(), axis.ticks = element_blank(), legend.position = "right",
        legend.text = element_text(size = 14), legend.title = element_blank(), 
        panel.grid = element_blank()) + 
    guides(fill = guide_colourbar(ticks = FALSE))
```


Human Perceptions across number of coyotes
```{r}
perc.num.table = table(Coyotes$HumanPerception, Coyotes$CoyoteNumber) # make a table

perc.num.chsq = chisq.test(perc.num.table[2:4,1:5]) # run a chi square test

perc.num.chsq.resids = chisq.posthoc.test(perc.num.table[2:4,1:5], method = "holm") # run a posthoc test


# formatting a new data frame
perc.num.chsq.resids.long = pivot_longer(perc.num.chsq.resids, cols = c(More, One, Two, Three, Unknown))
perc.num.chsq.resids.long = data.frame(Perc = subset(perc.num.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Num =  subset(perc.num.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(perc.num.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(perc.num.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Perc = fct_relevel(Perc, "Positive", "Neutral", "Negative"), 
         Num  = fct_relevel(Num, "One", "Two", "Three", "More", "Unknown")) 

summary(bold.num.chsq.resids.long$Resids)

# plotting! 
perc.num.chsq.plot = 
  ggplot(perc.num.chsq.resids.long, aes(y = Num, x = Perc, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 6,color="grey30") +
   scale_fill_distiller(palette = "RdYlBu", na.value = "grey80", limits =c(-7,7.5), breaks = c(-7,0,7), labels = c(-7, 0, 7), direction=1)+ 

#  scale_fill_viridis(option = "turbo", direction = -1,limits = c(-15,15)) + 
  ylab(NULL)+ xlab(NULL)+ 
  theme_bw()+ 
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
    theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        legend.text = element_text(size = 14), legend.title = element_blank(),
        panel.grid = element_blank()) + 
    guides(fill = guide_colourbar(ticks = FALSE))
```

Human Perceptions across coyote health
```{r}
perc.health.table = table(Coyotes$HumanPerception, Coyotes$Health) # make a table

perc.health.chsq = chisq.test(perc.health.table[2:4,]) # run a chi square test

perc.health.chsq.resids = chisq.posthoc.test(perc.health.table[2:4,], method = "holm") # run a posthoc test


# formatting a new data frame
perc.health.chsq.resids.long = pivot_longer(perc.health.chsq.resids, cols = c(Healthy, Unhealthy, Unknown))
perc.health.chsq.resids.long = data.frame(Perc = subset(perc.health.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Health =  subset(perc.health.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(perc.health.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(perc.health.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Perc = fct_relevel(Perc, "Positive", "Neutral", "Negative"), 
         Health  = fct_relevel(Health, "Healthy", "Unhealthy", "Unknown")) 

# plotting! 
perc.health.chsq.plot=
  ggplot(perc.health.chsq.resids.long, aes(y = Health, x = Perc, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 6, color="grey30") + ylab(NULL) + xlab(NULL)+
   scale_fill_distiller(palette = "RdYlBu", na.value = "grey80", limits =c(-11,12.5), breaks = c(-10,0,12), labels = c(-10, 0, 12), direction=1)+ 
#  scale_fill_viridis("Residuals", option = "turbo", direction = -1, limits = c(-15,15)) +
  theme_bw() + 
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        legend.text = element_text(size = 14), legend.title = element_blank(),
        panel.grid = element_blank()) + 
    guides(fill = guide_colourbar(ticks = FALSE))
```


Now plot a bunch of those contextual variables together
```{r}
  ggdraw()+
  draw_plot(bold.act.chsq.plot, x= 0, y = 0.55, width =0.3, height =.45)+
  draw_plot_label(label = "A.", x=0.087, y=1, size =25, color ="black")+
  draw_plot(bold.vul.chsq.plot, x= 0.3, y = 0.55, width =0.2, height =.45) +
  draw_plot_label(label = "B.", x=0.302, y=1, size =25, color ="black")+
  draw_plot(bold.leash.chsq.plot, x= 0.5, y = 0.55, width =0.12, height =.45) + 
  draw_plot_label(label = "C.", x=0.502, y=1, size =25, color ="black")+
  draw_plot(bold.num.chsq.plot, x= 0.62, y = 0.55, width =0.18, height =.45) +
  draw_plot_label(label = "D.", x=0.622, y=1, size =25, color ="black")+
  draw_plot(bold.health.chsq.plot, x= 0.8, y = 0.55, width =0.2, height =.45) +
  draw_plot_label(label = "E.", x=0.802, y=1, size =25, color ="black")+
  draw_plot(perc.act.chsq.plot, x= 0, y = 0, width =.3, height =.55) + 
  draw_plot_label(label = "F.", x=0.09, y=0.55, size =25, color ="black")+
  draw_plot(perc.vul.chsq.plot, x= 0.3, y = 0, width =.2, height =.55) +
  draw_plot_label(label = "G.", x=0.30, y=0.55, size =25, color = "black")+
  draw_plot(perc.leash.chsq.plot, x= 0.5, y = 0, width =0.12, height =.55) + 
  draw_plot_label(label = "H.", x=0.50, y=0.55, size =25, color ="black")+
  draw_plot(perc.num.chsq.plot, x= 0.62, y = 0, width =.18, height =.55) + 
  draw_plot_label(label = "I.", x=0.63, y=0.55, size =25, color ="black")+
  draw_plot(perc.health.chsq.plot, x= 0.8, y = 0, width =.2, height =.55)  + 
  draw_plot_label(label = "J.", x=0.805, y=0.55, size =25, color ="black")


```


Now plot a bunch of those contextual variables together
```{r}
  

context.plot = 
  ggdraw()+
  draw_plot(bold.act.chsq.plot, x= 0, y = 0.7, height =0.3, width =.5)+
  draw_plot_label(label = "Pearson's Residuals", x=0.9, y=0.6, size =20, color ="black",  fontface = "plain",
 angle = -90, hjust = 0, vjust = 0)+

#  draw_plot_label(label = "A.", x=0.087, y=1, size =25, color ="black")+
  draw_plot(bold.vul.chsq.plot, x= 0.02, y = 0.5, height =0.2, width =.48) +
 # draw_plot_label(label = "B.", x=0.302, y=1, size =25, color ="black")+
  draw_plot(bold.leash.chsq.plot, x= 0.015, y = 0.35, height =0.15, width =.485) + 
#  draw_plot_label(label = "C.", x=0.502, y=1, size =25, color ="black")+
  draw_plot(bold.num.chsq.plot, x= 0.02, y = 0.15, height =0.2, width =.48) +
#  draw_plot_label(label = "D.", x=0.622, y=1, size =25, color ="black")+
  draw_plot(bold.health.chsq.plot, x= 0.01, y = 0, height =0.15, width =.49) +
#  draw_plot_label(label = "E.", x=0.802, y=1, size =25, color ="black")+
  draw_plot(perc.act.chsq.plot, x= .5, y = .7, height =.3, width =.38) + 
#  draw_plot_label(label = "F.", x=0.09, y=0.55, size =25, color ="black")+
  draw_plot(perc.vul.chsq.plot, x= .5, y = .5, height =.2, width =.38) +
#  draw_plot_label(label = "G.", x=0.30, y=0.55, size =25, color = "black")+
  draw_plot(perc.leash.chsq.plot, x= .5, y = .35, height =0.15, width =.365) + 
 # draw_plot_label(label = "H.", x=0.50, y=0.55, size =25, color ="black")+
  draw_plot(perc.num.chsq.plot, x= .5, y = 0.15, height =.2, width =.365) + 
 # draw_plot_label(label = "I.", x=0.63, y=0.55, size =25, color ="black")+
  draw_plot(perc.health.chsq.plot, x= .5, y = 0, height =.15, width =.38)  
#  draw_plot_label(label = "J.", x=0.805, y=0.55, size =25, color ="black")



save_plot("Figures/context.plot.jpeg", context.plot, base_width = 10, base_height= 10)

          
          


```

### Supplementary Figure X: Correlations between land cover and contextual variables


Land cover and human activity
```{r}
hab.act.table = table(Coyotes$Habitat, Coyotes$HumanActivity) # make a table

hab.act.chsq = chisq.test(hab.act.table) # run a chi square test
hab.act.chsq$expected # need to remove cycling and outdoor activity because expected chi square is less than 5

hab.act.chsq.resids = chisq.posthoc.test(hab.act.table, method = "holm") # run a posthoc test

# formatting a new data frame
hab.act.chsq.resids.long = pivot_longer(hab.act.chsq.resids, cols = c(Driving, Cycling, HomeYard, Unknown, Walking, OutdoorAct))
hab.act.chsq.resids.long = data.frame(Hab = subset(hab.act.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Act =  subset(hab.act.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(hab.act.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(hab.act.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
        Hab = recode(Hab, Com100m = "Commercial", Res100m = "Residential", Mod100m = "Modified Open", Mow100m = "Mowed",
                     Nat100m = "Natural"), 
         Act = fct_relevel(Act,  "Driving", "Cycling", "HomeYard", "Walking","OutdoorAct", "Unknown")) 

hab.act.chsq.resids.long$Hab = fct_relevel(hab.act.chsq.resids.long$Hab, 
                                            "Commercial", "Residential", "Mowed", "Modified Open","Natural")

# plotting!
hab.act.chsq.plot=
ggplot(hab.act.chsq.resids.long, aes(x = Act, y = Hab, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color="white") + 
  scale_fill_viridis("Residuals", option = "turbo", direction = -1,limits = c(-12,20)) +
  ylab("Land Cover Type") + xlab("Human Activity") + 
  theme_bw()+   
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none", 
        axis.text.x = element_text(size = 18, angle = 35, hjust = 1), axis.title= element_text(size = 20),
        axis.text.y = element_text(size = 18))


```

Land cover and  vulnerable individuals
```{r}
hab.vul.table = table(Coyotes$Habitat, Coyotes$VulnerableIndividual) # make a table

hab.vul.chsq = chisq.test(hab.vul.table) # run a chi square test

hab.vul.chsq.resids = chisq.posthoc.test(hab.vul.table, method = "holm") # run a posthoc test


# formatting a new data frame
hab.vul.chsq.resids.long = pivot_longer(hab.vul.chsq.resids, cols = c(Cat, Child, Dog, Multiple, Unknown))
hab.vul.chsq.resids.long = data.frame(Hab = subset(hab.vul.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Vul =  subset(hab.vul.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(hab.vul.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(hab.vul.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Hab = recode(Hab, Com100m = "Commercial", Res100m = "Residential", Mod100m = "Modified Open",
                      Mow100m = "Mowed", Nat100m = "Natural"), ) 

hab.vul.chsq.resids.long$Hab = fct_relevel(hab.vul.chsq.resids.long$Hab, 
                                            "Commercial", "Residential", "Mowed", "Modified Open","Natural")

# plotting! 
hab.vul.chsq.plot =
ggplot(hab.vul.chsq.resids.long, aes(x = Vul, y = Hab, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color = "white") + 
  scale_fill_viridis(option = "turbo", direction = -1,limits = c(-12,20)) + ylab(NULL)+ xlab("Vulnerable Individuals")+
  theme_bw()+   
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none",
        axis.text.y = element_blank(), axis.ticks.y = element_blank(),        
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1), axis.title.x= element_text(size = 20))



```

Land cover and dog leash stat
```{r}
hab.leash.table = table(Coyotes$Habitat, Coyotes$DogPresent) # make a table

hab.leash.chsq = chisq.test(hab.leash.table[,2:4]) # run a chi square test

hab.leash.chsq.resids = chisq.posthoc.test(hab.leash.table[,2:4], method = "holm") # run a posthoc test


# formatting a new data frame
hab.leash.chsq.resids.long = pivot_longer(hab.leash.chsq.resids, cols = c(Leashed, OffLeash, Unknown))
hab.leash.chsq.resids.long = data.frame(Hab = subset(hab.leash.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Leash =  subset(hab.leash.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(hab.leash.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(hab.leash.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Hab = recode(Hab, Com100m = "Commercial", Res100m = "Residential", Mod100m = "Modified Open",
                      Mow100m = "Mowed", Nat100m = "Natural")) 

hab.leash.chsq.resids.long$Hab = fct_relevel(hab.leash.chsq.resids.long$Hab, 
                                            "Commercial", "Residential", "Mowed", "Modified Open","Natural")

# plotting! 
hab.leash.chsq.plot=
  ggplot(hab.leash.chsq.resids.long, aes(x = Leash, y = Hab, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color="white") + ylab(NULL) + xlab("Dog Status")+
  scale_fill_viridis("Residuals", option = "turbo", direction = -1, limits = c(-12,20)) + theme_bw() +     
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), legend.position = "none",
        axis.text.x = element_text(size = 18, angle = 40, hjust = 1), axis.title.x= element_text(size = 20))
```

Land cover and  number of coyotes
```{r}
hab.num.table = table(Coyotes$Habitat, Coyotes$CoyoteNumber) # make a table

hab.num.chsq = chisq.test(hab.num.table) # run a chi square test

hab.num.chsq.resids = chisq.posthoc.test(hab.num.table, method = "holm") # run a posthoc test


# formatting a new data frame
hab.num.chsq.resids.long = pivot_longer(hab.num.chsq.resids, cols = c(More, One, Two, Three, Unknown))
hab.num.chsq.resids.long = data.frame(Hab = subset(hab.num.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Num =  subset(hab.num.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(hab.num.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(hab.num.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Num  = fct_relevel(Num, "One", "Two", "Three", "More", "Unknown"),
         Hab = recode(Hab, Com100m = "Commercial", Res100m = "Residential", Mod100m = "Modified Open",
                      Mow100m = "Mowed", Nat100m = "Natural")) 

hab.num.chsq.resids.long$Hab = fct_relevel(hab.num.chsq.resids.long$Hab, 
                                            "Commercial", "Residential", "Mowed", "Modified Open","Natural")

# plotting! 
hab.num.chsq.plot = 
  ggplot(hab.num.chsq.resids.long, aes(x = Num, y = Hab, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8,color="white") +
  scale_fill_viridis(option = "turbo", direction = -1,limits = c(-12,20)) + ylab(NULL)+ xlab("Coyote Number")+ 
  theme_bw()+   
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none",
        axis.text.y = element_blank(), axis.ticks.y = element_blank(),
                axis.text.x = element_text(size = 18, angle = 45, hjust = 1), axis.title.x= element_text(size = 20))
```

Land cover and  coyote health
```{r}
hab.health.table = table(Coyotes$Habitat, Coyotes$Health) # make a table

hab.health.chsq = chisq.test(hab.health.table) # run a chi square test

hab.health.chsq.resids = chisq.posthoc.test(hab.health.table, method = "holm") # run a posthoc test


# formatting a new data frame
hab.health.chsq.resids.long = pivot_longer(hab.health.chsq.resids, cols = c(Healthy, Unhealthy, Unknown))
hab.health.chsq.resids.long = data.frame(Hab = subset(hab.health.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Health =  subset(hab.health.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(hab.health.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(hab.health.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Health  = fct_relevel(Health, "Healthy", "Unhealthy", "Unknown"), 
         Hab = recode(Hab, Com100m = "Commercial", Res100m = "Residential", Mod100m = "Modified Open",
                      Mow100m = "Mowed", Nat100m = "Natural")) 

hab.health.chsq.resids.long$Hab = fct_relevel(hab.health.chsq.resids.long$Hab, 
                                            "Commercial", "Residential", "Mowed", "Modified Open","Natural")

# plotting! 
hab.health.chsq.plot=
  ggplot(hab.health.chsq.resids.long, aes(x = Health, y = Hab, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color="white") + ylab(NULL) + xlab("Coyote Health")+
  scale_fill_viridis("Residuals", option = "turbo", direction = -1, limits = c(-12,20)) + theme_bw() +
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), 
        legend.text = element_text(size = 18), legend.title = element_text(size = 20), 
        legend.key.height = unit(1.75,'cm'), legend.position = "right",
        axis.text.x = element_text(size = 18, angle = 40, hjust = 1), axis.title.x= element_text(size = 20))+ 
    guides(fill = guide_colourbar(ticks = FALSE))
```

now create supplementary figure comparing contextual vars and habitat
```{r}
land.cover.context.plot =   
ggdraw()+
  draw_plot(hab.act.chsq.plot, x= 0, y = 0, width =0.3, height =1)+ 
  draw_plot(hab.vul.chsq.plot, x= 0.3, y = 0, width =0.2, height =1) +
  draw_plot(hab.leash.chsq.plot, x= 0.5, y = 0, width =0.15, height =1) +
  draw_plot(hab.num.chsq.plot, x= 0.65, y = 0, width =0.15, height =1) +
  draw_plot(hab.health.chsq.plot, x= 0.8, y = 0, width =0.2, height =1) +
  draw_plot_label(label = "A.", x=0.1, y=0.985, size =25, color ="white")+
  draw_plot_label(label = "B.", x=0.305, y=0.985, size =25, color ="white")+
  draw_plot_label(label = "C.", x=0.505, y=0.985, size =25, color ="white")+
  draw_plot_label(label = "D.", x=0.655, y=0.985, size =25, color ="white") +
  draw_plot_label(label = "E.", x=0.805, y=0.985, size =25, color ="white")

save_plot("Figures/land.cover.context.plot.jpeg", land.cover.context.plot, base_width = 20, base_height= 7)


```


### Supplementary Figure X: Correlations between SEASON and contextual variables


Season and human activity
```{r}
szn.act.table = table(Coyotes$Season, Coyotes$HumanActivity) # make a table

szn.act.chsq = chisq.test(szn.act.table) # run a chi square test
szn.act.chsq$expected # need to remove cycling and outdoor activity because expected chi square is less than 5

szn.act.chsq.resids = chisq.posthoc.test(szn.act.table, method = "holm") # run a posthoc test

# formatting a new data frame
szn.act.chsq.resids.long = pivot_longer(szn.act.chsq.resids, cols = c(Driving, Cycling, HomeYard, Unknown, Walking, OutdoorAct))
szn.act.chsq.resids.long = data.frame(Season = subset(szn.act.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Act =  subset(szn.act.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(szn.act.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(szn.act.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Act = fct_relevel(Act,  "Driving", "Cycling", "HomeYard", "Walking","OutdoorAct", "Unknown")) 

szn.act.chsq.resids.long$Season = fct_relevel(szn.act.chsq.resids.long$Season, 
                                            "Dispersal", "PupRearing", "Breeding")

# plotting!
szn.act.chsq.plot=
ggplot(szn.act.chsq.resids.long, aes(x = Act, y = Season, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color="white") + 
  scale_fill_viridis("Residuals", option = "turbo", direction = -1, limits = c(-6,6)) +
  ylab("Season") + xlab("Human Activity") + 
  theme_bw()+   
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none", 
        axis.text.x = element_text(size = 18, angle = 35, hjust = 1), axis.title= element_text(size = 20),
        axis.text.y = element_text(size = 18))


```

Season and  vulnerable individuals
```{r}
szn.vul.table = table(Coyotes$Season, Coyotes$VulnerableIndividual) # make a table

szn.vul.chsq = chisq.test(szn.vul.table) # run a chi square test

szn.vul.chsq.resids = chisq.posthoc.test(szn.vul.table, method = "holm") # run a posthoc test


# formatting a new data frame
szn.vul.chsq.resids.long = pivot_longer(szn.vul.chsq.resids, cols = c(Cat, Child, Dog, Multiple, Unknown))
szn.vul.chsq.resids.long = data.frame(Season = subset(szn.vul.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Vul =  subset(szn.vul.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(szn.vul.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(szn.vul.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))))


szn.vul.chsq.resids.long$Season = fct_relevel(szn.vul.chsq.resids.long$Season, 
                                            "Dispersal", "PupRearing", "Breeding")
# plotting! 
szn.vul.chsq.plot =
ggplot(szn.vul.chsq.resids.long, aes(x = Vul, y = Season, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color = "white") + 
  scale_fill_viridis(option = "turbo", direction = -1,limits = c(-7,7)) + ylab(NULL)+ xlab("Vulnerable Individuals")+
  theme_bw()+   
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none",
        axis.text.y = element_blank(), axis.ticks.y = element_blank(),        
        axis.text.x = element_text(size = 18, angle = 45, hjust = 1), axis.title.x= element_text(size = 20))



```

Season and dog leash stat
```{r}
szn.leash.table = table(Coyotes$Season, Coyotes$DogPresent) # make a table

szn.leash.chsq = chisq.test(szn.leash.table[,2:4]) # run a chi square test

szn.leash.chsq.resids = chisq.posthoc.test(szn.leash.table[,2:4], method = "holm") # run a posthoc test


# formatting a new data frame
szn.leash.chsq.resids.long = pivot_longer(szn.leash.chsq.resids, cols = c(Leashed, OffLeash, Unknown))
szn.leash.chsq.resids.long = data.frame(Season = subset(szn.leash.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Leash =  subset(szn.leash.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(szn.leash.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(szn.leash.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))))

szn.leash.chsq.resids.long$Season = fct_relevel(szn.leash.chsq.resids.long$Season, 
                                            "Dispersal", "PupRearing", "Breeding")
# plotting! 
szn.leash.chsq.plot=
  ggplot(szn.leash.chsq.resids.long, aes(x = Leash, y = Season, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color="white") + ylab(NULL) + xlab("Dog Status")+
  scale_fill_viridis("Residuals", option = "turbo", direction = -1, limits = c(-7,7)) + theme_bw() +     
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), legend.position = "none",
        axis.text.x = element_text(size = 18, angle = 40, hjust = 1), axis.title.x= element_text(size = 20))
```

Season and  number of coyotes
```{r}
szn.num.table = table(Coyotes$Season, Coyotes$CoyoteNumber) # make a table

szn.num.chsq = chisq.test(szn.num.table) # run a chi square test

szn.num.chsq.resids = chisq.posthoc.test(szn.num.table, method = "holm") # run a posthoc test


# formatting a new data frame
szn.num.chsq.resids.long = pivot_longer(szn.num.chsq.resids, cols = c(More, One, Two, Three, Unknown))
szn.num.chsq.resids.long = data.frame(Season = subset(szn.num.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Num =  subset(szn.num.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(szn.num.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(szn.num.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Num  = fct_relevel(Num, "One", "Two", "Three", "More", "Unknown"))

szn.num.chsq.resids.long$Season = fct_relevel(szn.num.chsq.resids.long$Season, 
                                            "Dispersal", "PupRearing", "Breeding")

# plotting! 
szn.num.chsq.plot = 
  ggplot(szn.num.chsq.resids.long, aes(x = Num, y = Season, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8,color="white") +
  scale_fill_viridis(option = "turbo", direction = -1,limits = c(-7,7)) + ylab(NULL)+ xlab("Coyote Number")+ 
  theme_bw()+   
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "none",
        axis.text.y = element_blank(), axis.ticks.y = element_blank(),
                axis.text.x = element_text(size = 18, angle = 45, hjust = 1), axis.title.x= element_text(size = 20))
```

Season and  coyote health
```{r}
szn.health.table = table(Coyotes$Season, Coyotes$Health) # make a table

szn.health.chsq = chisq.test(szn.health.table) # run a chi square test

szn.health.chsq.resids = chisq.posthoc.test(szn.health.table, method = "holm") # run a posthoc test


# formatting a new data frame
szn.health.chsq.long = pivot_longer(szn.health.chsq.resids, cols = c(Healthy, Unhealthy, Unknown))
szn.health.chsq.long = data.frame(Season = subset(szn.health.chsq.long, Value =="Residuals")$Dimension,
                                       Health =  subset(szn.health.chsq.long, Value =="Residuals")$name, 
                                       Resids = subset(szn.health.chsq.long, Value =="Residuals")$value, 
                                       Pval = subset(szn.health.chsq.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
         Health  = fct_relevel(Health, "Healthy", "Unhealthy", "Unknown"))

szn.health.chsq.long$Season = fct_relevel(szn.health.chsq.long$Season, 
                                            "Dispersal", "PupRearing", "Breeding")

# plotting! 
szn.health.chsq.plot=
  ggplot(szn.health.chsq.long, aes(x = Health, y = Season, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color="white") + ylab(NULL) + xlab("Coyote Health")+
  scale_fill_viridis("Residuals", option = "turbo", direction = -1, limits = c(-7,7)) + theme_bw() +
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), 
        legend.text = element_text(size = 18), legend.title = element_text(size = 20), 
        legend.key.height = unit(1.75,'cm'), legend.position = "right",
        axis.text.x = element_text(size = 18, angle = 40, hjust = 1), axis.title.x= element_text(size = 20))+ 
    guides(fill = guide_colourbar(ticks = FALSE))
```

now create supplementary figure comparing contextual vars and season
```{r}
  
season.contextual.plot = 
ggdraw()+
  draw_plot(szn.act.chsq.plot, x= 0, y = 0, width =0.3, height =1)+ 
  draw_plot(szn.vul.chsq.plot, x= 0.3, y = 0, width =0.2, height =1) +
  draw_plot(szn.leash.chsq.plot, x= 0.5, y = 0, width =0.15, height =1) +
  draw_plot(szn.num.chsq.plot, x= 0.65, y = 0, width =0.15, height =1) +
  draw_plot(szn.health.chsq.plot, x= 0.8, y = 0, width =0.2, height =1) +
  draw_plot_label(label = "A.", x=0.09, y=0.985, size =25, color ="white")+
  draw_plot_label(label = "B.", x=0.302, y=0.985, size =25, color ="white")+
  draw_plot_label(label = "C.", x=0.502, y=0.985, size =25, color ="white")+
  draw_plot_label(label = "D.", x=0.65, y=0.985, size =25, color ="white") +
  draw_plot_label(label = "E.", x=0.805, y=0.985, size =25, color ="white")

save_plot("Figures/season.context.plot.jpeg", season.contextual.plot, base_width = 20, base_height= 6)


```



### Supplementary Figure X: Relationship between coyote boldness and human concern
```{r}
bold.perc = subset(bold.data, HumanPerception != "Concern")
bold.perc = subset(bold.perc, HumanPerception != "Unknown") # total of 63 reports where both perception & boldness could be determined

bold.perc$HumanPerception = factor(bold.perc$HumanPerception, levels= c("Positive", "Neutral", "Negative"))

bold.perc$Bold = as.numeric(bold.perc$Bold) - 2
bold.perc$HumanPerception = as.numeric(bold.perc$HumanPerception)


summary(bold.perc$Bold) # four levels, 1-4
summary(bold.perc$HumanPerception) # three levels, 1-3

responselabs = c("Avoid", "Indifferent", "Bold", "Aggressive")
perceplabs = c("Positive", "Neutral", "Negative")


ggplot(bold.perc, aes(x = HumanPerception, y=Bold))+
  geom_jitter(width=0.1, height=0.2)+
  scale_y_continuous(breaks=1:4, labels = paste0(responselabs))+
  scale_x_continuous(breaks=seq(1,3,1), labels = paste0(perceplabs)) + 
  geom_smooth(method="lm", color="black") + 
  theme(axis.text = element_text(size=13), 
        axis.title = element_text(size=18))


cor.test(bold.perc$HumanPerception, bold.perc$Bold, method="spearman")

bold.per.table = table(bold.perc$HumanPerception, bold.perc$Bold) # make a table

bold.per.chsq = chisq.test(bold.per.table[,c(3:6)]) # run a chi square test

bold.per.chsq.resids = chisq.posthoc.test(bold.per.table[,c(3:6)], method = "holm") # run a posthoc test



# formatting a new data frame
bold.per.chsq.resids.long = pivot_longer(bold.per.chsq.resids, cols = c(Avoidance, Indifferent, Bold, Aggressive))
bold.per.chsq.resids.long = data.frame(HumanConcern = subset(bold.per.chsq.resids.long, Value =="Residuals")$Dimension,
                                       Bold =  subset(bold.per.chsq.resids.long, Value =="Residuals")$name, 
                                       Resids = subset(bold.per.chsq.resids.long, Value =="Residuals")$value, 
                                       Pval = subset(bold.per.chsq.resids.long, Value =="p values")$value) %>%
  mutate(sig = ifelse(Pval < 0.001, "***", ifelse(Pval < 0.01, "**", ifelse(Pval < 0.05, "*", "" ))),
        HumanConcern = fct_relevel(HumanConcern,  "Positive", "Neutral", "Negative"),
        Bold = fct_relevel(Bold,  "Avoidance", "Indifferent", "Bold", "Aggressive")) 

# plotting!
bold.per.chsq.plot=
ggplot(bold.per.chsq.resids.long, aes(x = HumanConcern, y = Bold, fill = Resids)) +
  geom_tile() + geom_text(aes(label = sig), size = 8, color="white") + 
  scale_fill_distiller("Pearson's\nResiduals",palette = "RdYlGn", na.value = "grey80", 
                       limits =c(-5,5), breaks = c(-5,0,5), labels = c(-5, 0, 5), direction=1)+ 
  ylab("Coyote Boldness") + xlab("Human Concern") + 
  theme_bw()+   
  scale_x_discrete(expand =c(0,0))+ scale_y_discrete(expand = c(0,0))+
  theme(legend.position = "right", 
        axis.text.x = element_text(size = 18), axis.title= element_text(size = 20),
        axis.text.y = element_text(size = 18))


```












